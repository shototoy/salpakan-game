<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Salpakan: Imperium</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    const TILESET_CONFIG = {
      url: 'assets/imperium.svg',
      cellWidth: 240,
      cellHeight: 200,
      columns: 5,
      totalWidth: 1200,
      totalHeight: 600
    };

    const RANKS = [
      { r: 'PVT', count: 6, tileX: 0, tileY: 0 },
      { r: 'SGT', count: 2, tileX: 1, tileY: 0 },
      { r: '2LT', count: 1, tileX: 2, tileY: 0 },
      { r: '1LT', count: 1, tileX: 3, tileY: 0 },
      { r: 'CPT', count: 1, tileX: 4, tileY: 0 },
      { r: 'MAJ', count: 1, tileX: 0, tileY: 1 },
      { r: 'LTC', count: 1, tileX: 1, tileY: 1 },
      { r: 'COL', count: 1, tileX: 2, tileY: 1 },
      { r: '1‚òÖ', count: 1, tileX: 3, tileY: 1 },
      { r: '2‚òÖ', count: 1, tileX: 4, tileY: 1 },
      { r: '3‚òÖ', count: 1, tileX: 0, tileY: 2 },
      { r: '4‚òÖ', count: 1, tileX: 1, tileY: 2 },
      { r: '5‚òÖ', count: 1, tileX: 2, tileY: 2 },
      { r: 'SPY', count: 2, tileX: 3, tileY: 2 },
      { r: 'FLAG', count: 1, tileX: 4, tileY: 2 }
    ];

    const POWER = {
      '5‚òÖ': 15, '4‚òÖ': 14, '3‚òÖ': 13, '2‚òÖ': 12, '1‚òÖ': 11, 'COL': 10, 'LTC': 9, 'MAJ': 8, 'CPT': 7,
      '1LT': 6, '2LT': 5, 'SGT': 4, 'PVT': 2, 'SPY': 1, 'FLAG': 0
    };

    const createPieces = (p) => {
      const pieces = [];
      let id = 0;
      RANKS.forEach(({ r, count }) => {
        for (let i = 0; i < count; i++) {
          pieces.push({ r, p, id: p * 100 + id++ });
        }
      });
      return pieces;
    };

    const initBoard = () => Array(8).fill(null).map(() => Array(9).fill(null));

    const autoSetup = (b, p) => {
      const nb = b.map(row => [...row]);
      const pieces = createPieces(p).sort(() => Math.random() - 0.5);
      const rows = p === 1 ? [7, 6, 5] : [0, 1, 2];
      let idx = 0;
      for (const r of rows) {
        for (let c = 0; c < 9; c++) {
          if (idx < 21) nb[r][c] = pieces[idx++];
        }
      }
      return nb;
    };

    const battle = (a, d) => {
      if (a.r === 'FLAG' || d.r === 'FLAG') return a.r === 'FLAG' ? 'lose' : 'win';
      if (a.r === 'SPY') return d.r === '5‚òÖ' ? 'win' : 'lose';
      if (d.r === 'SPY') return a.r === 'PVT' ? 'win' : 'lose';
      return POWER[a.r] > POWER[d.r] ? 'win' : POWER[a.r] < POWER[d.r] ? 'lose' : 'draw';
    };

    const validMoves = (b, r, c) => {
      const dirs = [[-1, 0], [1, 0], [0, -1], [0, 1]];
      return dirs.map(([dr, dc]) => [r + dr, c + dc])
        .filter(([nr, nc]) => nr >= 0 && nr < 8 && nc >= 0 && nc < 9 && (!b[nr][nc] || b[nr][nc].p !== b[r][c].p));
    };

    const aiMove = (b) => {
      const pieces = [];
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 9; c++) {
          if (b[r][c]?.p === 2) pieces.push([r, c]);
        }
      }
      const moves = [];
      pieces.forEach(([r, c]) => {
        validMoves(b, r, c).forEach(to => {
          let score = Math.random() * 10;
          const piece = b[r][c];
          if (b[to[0]][to[1]]) {
            const result = battle(piece, b[to[0]][to[1]]);
            score += result === 'win' ? 50 : result === 'draw' ? 20 : -30;
          }
          if (to[0] === 7) score += 30;
          if (piece.r === 'FLAG') score -= 50;
          moves.push({ from: [r, c], to, score });
        });
      });
      moves.sort((a, b) => b.score - a.score);
      return moves.length > 0 ? { from: moves[0].from, to: moves[0].to } : null;
    };

  function PieceIcon({ rank, player }) {
      const rankData = RANKS.find(r => r.r === rank);
      if (!rankData) return <span className="text-yellow-600 font-bold text-2xl">{rank}</span>;
      
      const { tileX, tileY } = rankData;
      const { cellWidth, cellHeight } = TILESET_CONFIG;
      
      return (
        <svg 
          viewBox={`${tileX * cellWidth} ${tileY * cellHeight} ${cellWidth} ${cellHeight}`}
          style={{
            width: '100%',
            height: '100%',
            filter: player === 2 ? 'hue-rotate(180deg) saturate(0.7) brightness(0.9)' : 'none'
          }}
        >
          <image 
            href={TILESET_CONFIG.url} 
            width="1200" 
            height="600"
            style={{ imageRendering: 'crisp-edges' }}
          />
        </svg>
      );
    }
    function Salpakan() {
      const [board, setBoard] = useState(initBoard());
      const [phase, setPhase] = useState('setup');
      const [mode, setMode] = useState(null);
      const [turn, setTurn] = useState(1);
      const [sel, setSel] = useState(null);
      const [moves, setMoves] = useState([]);
      const [msg, setMsg] = useState('Choose Mode');
      const [devMode, setDevMode] = useState(false);
      const [setupPlayer, setSetupPlayer] = useState(1);
      const [inventory, setInventory] = useState({});
      const [showPicker, setShowPicker] = useState(null);
      const [showTurnLock, setShowTurnLock] = useState(false);
      const [pausePhase, setPausePhase] = useState(false);

      const startSetup = (m) => {
        setMode(m);
        setBoard(initBoard());
        const inv = {};
        RANKS.forEach(({ r, count }) => { inv[r] = count; });
        setInventory(inv);
        setSetupPlayer(1);
        setPhase('setup');
        setMsg('Deploy Your Forces');
      };

      const finishSetup = () => {
        const totalPieces = Object.values(inventory).reduce((sum, count) => sum + count, 0);
        if (totalPieces > 0) {
          setMsg('Deploy All Units!');
          return;
        }
        if (setupPlayer === 1 && mode === '2player') {
          setShowTurnLock(true);
          setPausePhase(true);
        } else if (setupPlayer === 1 && mode === 'ai') {
          const nb = autoSetup(board, 2);
          setBoard(nb);
          setPhase('playing');
          setTurn(1);
          setMsg('Engage the Enemy');
        } else {
          setPhase('playing');
          setTurn(1);
          setShowTurnLock(true);
          setPausePhase(true);
        }
      };

      const confirmTurn = () => {
        if (pausePhase && setupPlayer === 1 && mode === '2player') {
          setSetupPlayer(2);
          const inv = {};
          RANKS.forEach(({ r, count }) => { inv[r] = count; });
          setInventory(inv);
          setMsg('Deploy Your Forces');
          setShowTurnLock(false);
          setPausePhase(false);
        } else if (pausePhase && phase === 'setup') {
          setPhase('playing');
          setTurn(1);
          setMsg('Imperium Commander 1');
          setShowTurnLock(false);
          setPausePhase(false);
        } else {
          setShowTurnLock(false);
        }
      };

      const placeOnBoard = (r, c, rank) => {
        if (board[r][c]) return;
        const nb = board.map(row => [...row]);
        nb[r][c] = { r: rank, p: setupPlayer, id: setupPlayer * 100 + Math.random() };
        setBoard(nb);
        setInventory({ ...inventory, [rank]: inventory[rank] - 1 });
        setShowPicker(null);
      };

      const removeFromBoard = (r, c) => {
        const piece = board[r][c];
        if (!piece || piece.p !== setupPlayer) return;
        const nb = board.map(row => [...row]);
        nb[r][c] = null;
        setBoard(nb);
        setInventory({ ...inventory, [piece.r]: inventory[piece.r] + 1 });
      };

      const handleSetupClick = (r, c) => {
        const rows = setupPlayer === 1 ? [7, 6, 5] : [0, 1, 2];
        if (!rows.includes(r)) return;
        
        if (board[r][c]) {
          removeFromBoard(r, c);
        } else {
          setShowPicker([r, c]);
        }
      };

      const handlePlayClick = (r, c) => {
        if (mode === 'ai' && turn !== 1) return;
        
        if (!sel) {
          if (board[r][c]?.p === turn) {
            setSel([r, c]);
            setMoves(validMoves(board, r, c));
          }
        } else {
          const [sr, sc] = sel;
          const validMove = moves.some(([mr, mc]) => mr === r && mc === c);
          
          if (validMove) {
            const nb = board.map(row => [...row]);
            const attacker = nb[sr][sc];
            const defender = nb[r][c];
            
            if (defender) {
              const res = battle(attacker, defender);
              if (res === 'win') {
                nb[r][c] = attacker;
                nb[sr][sc] = null;
                if (defender.r === 'FLAG') {
                  setMsg(`Victory - Commander ${turn}!`);
                  setBoard(nb);
                  setMoves([]);
                  setSel(null);
                  return;
                }
              } else if (res === 'lose') {
                nb[sr][sc] = null;
              } else {
                nb[r][c] = null;
                nb[sr][sc] = null;
              }
            } else {
              nb[r][c] = attacker;
              nb[sr][sc] = null;
            }
            
            setBoard(nb);
            setSel(null);
            setMoves([]);
            
            if (mode === 'ai') {
              setTurn(2);
              setMsg('Enemy Calculating...');
              setTimeout(() => {
                const aiM = aiMove(nb);
                if (!aiM) { setMsg('Imperial Victory!'); return; }
                
                const nb2 = nb.map(row => [...row]);
                const [ar, ac] = aiM.from;
                const [tr, tc] = aiM.to;
                const aiA = nb2[ar][ac];
                const def = nb2[tr][tc];
                
                if (def) {
                  const res = battle(aiA, def);
                  if (res === 'win') {
                    nb2[tr][tc] = aiA;
                    nb2[ar][ac] = null;
                    if (def.r === 'FLAG') { setMsg('Defeat - Enemy Prevails'); setBoard(nb2); return; }
                  } else if (res === 'lose') {
                    nb2[ar][ac] = null;
                  } else {
                    nb2[tr][tc] = null;
                    nb2[ar][ac] = null;
                  }
                } else {
                  nb2[tr][tc] = aiA;
                  nb2[ar][ac] = null;
                }
                
                setBoard(nb2);
                setTurn(1);
                setMsg('Engage the Enemy');
              }, 800);
            } else {
              const nextTurn = turn === 1 ? 2 : 1;
              setTurn(nextTurn);
              setShowTurnLock(true);
            }
          } else {
            setSel(null);
            setMoves([]);
          }
        }
      };

      const renderBoard = () => {
        const perspective = phase === 'playing' && mode === '2player' ? turn : setupPlayer;
        const displayBoard = perspective === 2 ? [...board].reverse().map(row => [...row].reverse()) : board;
        
        return displayBoard.map((row, r) => {
          const actualR = perspective === 2 ? 7 - r : r;
          return (
            <div key={r} className="flex" style={{ flex: 1 }}>
              {row.map((cell, c) => {
                const actualC = perspective === 2 ? 8 - c : c;
                const isSelected = sel?.[0] === actualR && sel?.[1] === actualC;
                const isValidMove = moves.some(([mr, mc]) => mr === actualR && mc === actualC);
                const canSee = devMode || !cell || cell.p === (phase === 'playing' ? turn : setupPlayer);
                
                return (
                  <div
                    key={c}
                    onClick={() => phase === 'setup' ? handleSetupClick(actualR, actualC) : handlePlayClick(actualR, actualC)}
                    className={`flex items-center justify-center cursor-pointer transition-all ${
                      isSelected ? 'bg-yellow-600 shadow-[inset_0_0_20px_rgba(255,215,0,0.6)]' : 
                      isValidMove ? 'bg-emerald-700 hover:bg-emerald-600' :
                      'bg-gradient-to-br from-amber-900 to-yellow-900 hover:from-amber-800 hover:to-yellow-800'
                    } ${c === 0 ? 'border-l-2' : ''} ${r === 0 ? 'border-t-2' : ''} border-r-2 border-b-2 border-yellow-700`}
                    style={{ flex: 1, aspectRatio: '1/1' }}
                  >
                    {cell ? (canSee ? <PieceIcon rank={cell.r} player={cell.p} /> : 
                      <div className="text-2xl font-serif text-yellow-600">?</div>) : ''}
                  </div>
                );
              })}
            </div>
          );
        });
      };

      return (
        <div className="h-screen w-screen flex flex-col lg:grid lg:grid-cols-[1fr_380px] bg-black">
          <div className="flex-1 flex items-center justify-center p-2 md:p-4 min-h-0 bg-gradient-to-br from-zinc-950 via-stone-950 to-zinc-950">
            <div className="w-full h-full max-w-[min(90vw,90vh)] max-h-[min(90vw,60vh)] lg:max-w-[90vh] lg:max-h-[90vh] flex flex-col rounded-lg shadow-[0_0_40px_rgba(212,175,55,0.3)] overflow-hidden border-4 border-yellow-700">
              {renderBoard()}
            </div>
          </div>

          <div className="bg-gradient-to-b from-zinc-900 to-black border-t lg:border-t-0 lg:border-l-4 border-yellow-700 flex flex-col p-4 overflow-y-auto max-h-[40vh] lg:max-h-full">
            <div className="text-center mb-4 pb-4 border-b-2 border-yellow-800">
              <h1 className="text-2xl md:text-3xl lg:text-4xl font-serif font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-400 via-yellow-500 to-yellow-600 tracking-wider">
                IMPERIUM
              </h1>
              <div className="text-xs text-yellow-600 italic mt-1 font-serif tracking-widest">SALPAKAN</div>
            </div>
            
            {phase === 'setup' && mode === null && (
              <div className="flex flex-col gap-3 mb-4">
                <button onClick={() => startSetup('ai')} 
                  className="px-6 py-3 bg-gradient-to-r from-yellow-700 to-yellow-800 text-black text-lg font-serif font-bold rounded border-2 border-yellow-600 hover:from-yellow-600 hover:to-yellow-700 shadow-lg transform hover:scale-105 transition-all">
                  ‚öî VS MACHINE
                </button>
                <button onClick={() => startSetup('2player')} 
                  className="px-6 py-3 bg-gradient-to-r from-yellow-700 to-yellow-800 text-black text-lg font-serif font-bold rounded border-2 border-yellow-600 hover:from-yellow-600 hover:to-yellow-700 shadow-lg transform hover:scale-105 transition-all">
                  ‚öî VS COMMANDER
                </button>
              </div>
            )}
            
            <div className="text-center text-lg text-yellow-400 mb-4 font-serif font-bold px-4 py-3 bg-black rounded border-2 border-yellow-800">
              {msg}
            </div>
            
            {phase === 'setup' && (
              <div className="mb-4 px-4 py-3 bg-zinc-900 rounded border-2 border-yellow-900">
                <div className="text-yellow-500 text-base font-serif font-bold">
                  Units Remaining: <span className="text-yellow-300 text-xl">{Object.values(inventory).reduce((sum, count) => sum + count, 0)}</span> / 21
                </div>
              </div>
            )}
            
            <div className="flex flex-col gap-2 mt-auto">
              {phase === 'setup' && (
                <>
                  <button onClick={finishSetup} 
                    className="px-4 py-2 bg-gradient-to-r from-green-700 to-green-800 text-white text-base font-serif font-bold rounded border-2 border-green-600 hover:from-green-600 hover:to-green-700 shadow-lg">
                    {setupPlayer === 1 && mode === '2player' ? '‚Üí NEXT COMMANDER' : '‚öî BEGIN BATTLE'}
                  </button>
                  <button onClick={() => {
                    const nb = autoSetup(board, setupPlayer);
                    setBoard(nb);
                    const inv = {};
                    RANKS.forEach(({ r }) => { inv[r] = 0; });
                    setInventory(inv);
                  }} className="px-4 py-2 bg-gradient-to-r from-purple-800 to-purple-900 text-yellow-300 text-base font-serif font-bold rounded border-2 border-purple-700 hover:from-purple-700 hover:to-purple-800 shadow-lg">
                    ‚ö° AUTO DEPLOY
                  </button>
                </>
              )}
              <button onClick={() => setDevMode(!devMode)} 
                className="px-4 py-2 bg-gradient-to-r from-orange-800 to-orange-900 text-white text-base font-serif font-bold rounded border-2 border-orange-700 hover:from-orange-700 hover:to-orange-800 shadow-lg">
                üëÅ OMNISCIENCE: {devMode ? 'ON' : 'OFF'}
              </button>
              <button onClick={() => { setBoard(initBoard()); setPhase('setup'); setMode(null); setMsg('Choose Mode'); setInventory({}); setSel(null); setMoves([]); setShowPicker(null); setShowTurnLock(false); }} 
                className="px-4 py-2 bg-gradient-to-r from-red-900 to-red-950 text-yellow-300 text-base font-serif font-bold rounded border-2 border-red-800 hover:from-red-800 hover:to-red-900 shadow-lg">
                ‚Üª RESET CAMPAIGN
              </button>
            </div>
          </div>

          {showPicker && (
            <div className="fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-50 p-4"
                 onClick={() => setShowPicker(null)}>
              <div className="bg-gradient-to-br from-zinc-900 to-black p-6 rounded-lg shadow-2xl max-w-lg w-full border-4 border-yellow-700 max-h-[90vh] overflow-y-auto"
                   onClick={(e) => e.stopPropagation()}>
                <h2 className="text-2xl font-serif font-black text-yellow-400 mb-4 text-center tracking-wider">SELECT UNIT</h2>
                <div className="grid grid-cols-5 gap-2">
                  {RANKS.map(({ r, count }) => (
                    inventory[r] > 0 && (
                      <button
                        key={r}
                        onClick={() => placeOnBoard(showPicker[0], showPicker[1], r)}
                        className="px-2 py-3 rounded border-2 bg-gradient-to-br from-yellow-700 to-yellow-800 border-yellow-600 hover:from-yellow-600 hover:to-yellow-700 font-serif font-bold text-sm transition-all hover:scale-110 shadow-lg flex flex-col items-center"
                      >
                        <PieceIcon rank={r} player={setupPlayer} size="sm" />
                        <div className="text-xs mt-1 bg-black bg-opacity-50 rounded px-1 text-yellow-300">√ó{inventory[r]}</div>
                      </button>
                    )
                  ))}
                </div>
                <button onClick={() => setShowPicker(null)} 
                        className="mt-4 w-full px-4 py-2 bg-red-900 text-yellow-300 rounded border-2 border-red-800 hover:bg-red-800 font-serif font-bold">
                  CANCEL
                </button>
              </div>
            </div>
          )}

          {showTurnLock && (
            <div className="fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-50 p-4">
              <div className="bg-gradient-to-br from-zinc-900 to-black p-10 rounded-lg shadow-2xl max-w-md w-full border-4 border-yellow-700 text-center">
                <div className="text-6xl mb-4">‚öî</div>
                <h2 className="text-3xl font-serif font-black text-yellow-400 mb-3 tracking-wider">
                  {pausePhase ? (setupPlayer === 1 && mode === '2player' ? 'COMMANDER 2' : 'BATTLE BEGINS') : `COMMANDER ${turn}`}
                </h2>
                <p className="text-lg text-yellow-600 mb-6 font-serif">
                  {pausePhase ? 'Transfer command authority' : 'Prepare your strategy'}
                </p>
                <button onClick={confirmTurn}
                        className="px-8 py-3 bg-gradient-to-r from-yellow-700 to-yellow-800 text-black text-xl rounded border-2 border-yellow-600 font-serif font-bold hover:from-yellow-600 hover:to-yellow-700 shadow-2xl transform hover:scale-105 transition-all w-full">
                  READY ‚úì
                </button>
                <p className="text-xs text-yellow-700 mt-4 italic font-serif">
                  Honor demands proper turn order
                </p>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<Salpakan />, document.getElementById('root'));
  </script>
</body>
</html>