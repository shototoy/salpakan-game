<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Salpakan: Imperium</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    const TILESET_CONFIG = {
      url: 'assets/imperium.svg',
      cellWidth: 240,
      cellHeight: 200,
      columns: 5,
      totalWidth: 1200,
      totalHeight: 600
    };

    const RANKS = [
      { r: 'PVT', count: 5, tileX: 0, tileY: 0 },
      { r: 'SGT', count: 2, tileX: 1, tileY: 0 },
      { r: '2LT', count: 1, tileX: 2, tileY: 0 },
      { r: '1LT', count: 1, tileX: 3, tileY: 0 },
      { r: 'CPT', count: 1, tileX: 4, tileY: 0 },
      { r: 'MAJ', count: 1, tileX: 0, tileY: 1 },
      { r: 'LTC', count: 1, tileX: 1, tileY: 1 },
      { r: 'COL', count: 1, tileX: 2, tileY: 1 },
      { r: '1★', count: 1, tileX: 3, tileY: 1 },
      { r: '2★', count: 1, tileX: 4, tileY: 1 },
      { r: '3★', count: 1, tileX: 0, tileY: 2 },
      { r: '4★', count: 1, tileX: 1, tileY: 2 },
      { r: '5★', count: 1, tileX: 2, tileY: 2 },
      { r: 'SPY', count: 2, tileX: 3, tileY: 2 },
      { r: 'FLAG', count: 1, tileX: 4, tileY: 2 }
    ];

    const POWER = {
      '5★': 15, '4★': 14, '3★': 13, '2★': 12, '1★': 11, 'COL': 10, 'LTC': 9, 'MAJ': 8, 'CPT': 7,
      '1LT': 6, '2LT': 5, 'SGT': 4, 'PVT': 2, 'SPY': 1, 'FLAG': 0
    };

    const GameLogic = {
      createPieces: (p) => {
        const pieces = [];
        let id = 0;
        RANKS.forEach(({ r, count }) => {
          for (let i = 0; i < count; i++) {
            pieces.push({ r, p, id: p * 100 + id++ });
          }
        });
        return pieces;
      },

      initBoard: () => Array(8).fill(null).map(() => Array(9).fill(null)),

      autoSetup: (b, p) => {
        const nb = b.map(row => [...row]);
        const rows = p === 1 ? [7, 6, 5] : [0, 1, 2];
        
        for (const r of rows) {
          for (let c = 0; c < 9; c++) {
            nb[r][c] = null;
          }
        }
        
        const pieces = GameLogic.createPieces(p).sort(() => Math.random() - 0.5);
        let idx = 0;
        
        for (const r of rows) {
          for (let c = 0; c < 9; c++) {
            if (idx < pieces.length) {
              nb[r][c] = pieces[idx++];
            }
          }
        }
        return nb;
      },

      battle: (a, d) => {
        if (d.r === 'FLAG') return 'win';
        if (a.r === 'FLAG') return 'lose';
        if (a.r === d.r) return 'draw';
        if (a.r === 'SPY' && d.r === 'PVT') return 'lose';
        if (a.r === 'SPY') return 'win';
        if (d.r === 'SPY' && a.r === 'PVT') return 'win';
        if (d.r === 'SPY') return 'lose';
        return POWER[a.r] > POWER[d.r] ? 'win' : 'lose';
      },

      validMoves: (b, r, c) => {
        const dirs = [[-1, 0], [1, 0], [0, -1], [0, 1]];
        return dirs.map(([dr, dc]) => [r + dr, c + dc])
          .filter(([nr, nc]) => nr >= 0 && nr < 8 && nc >= 0 && nc < 9 && (!b[nr][nc] || b[nr][nc].p !== b[r][c].p));
      },

      aiMove: (b) => {
        const pieces = [];
        for (let r = 0; r < 8; r++) {
          for (let c = 0; c < 9; c++) {
            if (b[r][c]?.p === 2) pieces.push([r, c]);
          }
        }
        
        if (pieces.length === 0) return null;
        
        const moves = [];
        pieces.forEach(([r, c]) => {
          const piece = b[r][c];
          if (!piece) return;
          
          const possibleMoves = GameLogic.validMoves(b, r, c);
          possibleMoves.forEach(to => {
            let score = Math.random() * 10;
            const target = b[to[0]][to[1]];
            
            if (target) {
              const result = GameLogic.battle(piece, target);
              score += result === 'win' ? 50 : result === 'draw' ? 20 : -30;
            }
            
            if (to[0] === 7) score += 30;
            if (piece.r === 'FLAG') score -= 100;
            
            moves.push({ from: [r, c], to, score });
          });
        });
        
        if (moves.length === 0) return null;
        
        moves.sort((a, b) => b.score - a.score);
        return { from: moves[0].from, to: moves[0].to };
      }
    };

const WebSocketManager = {
  ws: null,
  callbacks: {},

  connect: (roomId, playerId) => {
    if (WebSocketManager.ws) {
      console.log('Closing existing WebSocket connection');
      WebSocketManager.ws.close();
      WebSocketManager.ws = null;
    }

    const host = window.location.hostname;
    const port = 8080;

    console.log(`Creating NEW WebSocket connection: ws://${host}:${port}`);
    const ws = new WebSocket(`ws://${host}:${port}`);
    WebSocketManager.ws = ws;

    ws.onopen = () => {
      console.log('WebSocket opened, joining room:', roomId);
      ws.send(JSON.stringify({ type: 'join', roomId, playerId }));
    };

    ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log('🔵 WebSocket RAW message:', data.type);
  console.log('📦 Full data:', JSON.stringify(data));
  console.log('📋 Available handlers:', Object.keys(WebSocketManager.callbacks));
  
  const callback = WebSocketManager.callbacks[data.type];
  if (callback) {
    console.log(`✅ Handler found for: ${data.type}`);
    callback(data);
  } else {
    console.log(`❌ NO handler for: ${data.type}`);
  }
};
    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
    };

    ws.onclose = () => {
      console.log('WebSocket closed');
      WebSocketManager.ws = null;
    };

    return ws;
  },

  send: (data) => {
    if (WebSocketManager.ws && WebSocketManager.ws.readyState === WebSocket.OPEN) {
      console.log('Sending message:', data);
      WebSocketManager.ws.send(JSON.stringify(data));
    } else {
      console.error('WebSocket not ready! State:', WebSocketManager.ws?.readyState);
      console.error('Attempted to send:', data);
    }
  },

  on: (type, callback) => {
    console.log(`Registering handler for: ${type}`);
    WebSocketManager.callbacks[type] = callback;
  },

  off: (type) => {
    console.log(`Removing handler for: ${type}`);
    delete WebSocketManager.callbacks[type];
  },

  disconnect: () => {
    console.log('Disconnecting WebSocket');
    if (WebSocketManager.ws) {
      WebSocketManager.ws.close();
      WebSocketManager.ws = null;
    }
    WebSocketManager.callbacks = {};
  }
};

    function PieceIcon({ rank, player }) {
      const rankData = RANKS.find(r => r.r === rank);
      if (!rankData) return <span className="text-yellow-600 font-bold text-2xl">{rank}</span>;
      
      const { tileX, tileY } = rankData;
      const cellWidth = 240;
      const cellHeight = 200;
      
      const padding = 30;
      const extractX = tileX * cellWidth + padding;
      const extractY = tileY * cellHeight + padding;
      const extractWidth = cellWidth - (padding * 2);
      const extractHeight = cellHeight - (padding * 2);
      
      const [hasError, setHasError] = React.useState(false);
      
      if (hasError) {
        return (
          <div className={`w-full h-full flex items-center justify-center text-xs md:text-sm font-bold font-serif ${
            player === 2 ? 'text-blue-400 bg-blue-900' : 'text-yellow-400 bg-yellow-900'
          } rounded border-2 ${player === 2 ? 'border-blue-600' : 'border-yellow-600'}`}>
            {rank}
          </div>
        );
      }
      
      return (
        <svg 
          viewBox={`${extractX} ${extractY} ${extractWidth} ${extractHeight}`}
          style={{
            width: '100%',
            height: '100%',
            filter: player === 2 ? 'hue-rotate(180deg) saturate(0.7) brightness(0.9)' : 'none'
          }}
        >
          <image 
            href={TILESET_CONFIG.url} 
            width="1200" 
            height="600"
            style={{ imageRendering: 'crisp-edges' }}
            onError={() => setHasError(true)}
          />
        </svg>
      );
    }

    function HomeScreen({ onModeSelect, devMode, setDevMode }) {
      return (
        <div className="h-screen w-screen flex items-center justify-center bg-gradient-to-br from-zinc-950 via-stone-950 to-zinc-950 p-4">
          <div className="bg-gradient-to-br from-zinc-900 to-black p-10 rounded-lg shadow-2xl max-w-md w-full border-4 border-yellow-700 text-center">
            <div className="text-6xl mb-4">⚔</div>
            <h2 className="text-4xl font-serif font-black text-yellow-400 mb-6 tracking-wider">IMPERIUM</h2>
            <p className="text-sm text-yellow-600 mb-8 font-serif italic tracking-widest">SALPAKAN</p>
            
            <div className="flex flex-col gap-3">
              <button onClick={() => onModeSelect('ai')} 
                className="px-6 py-3 bg-gradient-to-r from-yellow-700 to-yellow-800 text-black text-lg font-serif font-bold rounded border-2 border-yellow-600 hover:from-yellow-600 hover:to-yellow-700 shadow-lg transform hover:scale-105 transition-all">
                ⚔ VS MACHINE
              </button>
              
              <button onClick={() => onModeSelect('2player', 'local')} 
                className="px-6 py-3 bg-gradient-to-r from-yellow-700 to-yellow-800 text-black text-lg font-serif font-bold rounded border-2 border-yellow-600 hover:from-yellow-600 hover:to-yellow-700 shadow-lg transform hover:scale-105 transition-all">
                ⚔ VS LOCAL COMMANDER
              </button>
              
              <button onClick={() => onModeSelect('multiplayer')} 
                className="px-6 py-3 bg-gradient-to-r from-emerald-700 to-emerald-800 text-black text-lg font-serif font-bold rounded border-2 border-emerald-600 hover:from-yellow-600 hover:to-yellow-700 shadow-lg transform hover:scale-105 transition-all">
                ⚔ VS NETWORK COMMANDER
              </button>
            </div>
            
            <button onClick={() => setDevMode(!devMode)} 
              className="w-full mt-6 px-4 py-2 bg-gradient-to-r from-orange-800 to-orange-900 text-white text-base font-serif font-bold rounded border-2 border-orange-700 hover:from-orange-700 hover:to-orange-800 shadow-lg">
              👁 OMNISCIENCE: {devMode ? 'ON' : 'OFF'}
            </button>
            
            <p className="text-xs text-yellow-700 mt-4 italic font-serif">
              Choose your battle
            </p>
          </div>
        </div>
      );
    }

    function MultiplayerLobby({ onBack, onCreateRoom, onJoinRoom, roomId, setRoomId, availableRooms }) {
      return (
        <div className="h-screen w-screen flex items-center justify-center bg-gradient-to-br from-zinc-950 via-stone-950 to-zinc-950 p-4">
          <div className="bg-gradient-to-br from-zinc-900 to-black p-10 rounded-lg shadow-2xl max-w-md w-full border-4 border-yellow-700">
            <button onClick={onBack} 
              className="mb-4 text-yellow-600 hover:text-yellow-400 font-serif text-sm">
              ← Back
            </button>
            
            <div className="text-center mb-8">
              <div className="text-5xl mb-3">🌐</div>
              <h2 className="text-3xl font-serif font-black text-yellow-400 mb-2 tracking-wider">ONLINE BATTLE</h2>
              <p className="text-xs text-yellow-600 font-serif italic">Connect two devices</p>
            </div>
            
            <div className="flex flex-col gap-4">
              <button onClick={onCreateRoom} 
                className="px-6 py-4 bg-gradient-to-r from-emerald-700 to-emerald-800 text-white text-xl font-serif font-bold rounded border-2 border-emerald-600 hover:from-emerald-600 hover:to-emerald-700 shadow-lg transform hover:scale-105 transition-all">
                ➕ CREATE ROOM
              </button>
              
              {availableRooms && availableRooms.length > 0 && (
                <div className="mt-2">
                  <p className="text-yellow-600 font-serif text-sm mb-2 text-center">Available Rooms:</p>
                  <div className="space-y-2 max-h-40 overflow-y-auto">
                    {availableRooms.map(room => (
                      <button 
                        key={room.id}
                        onClick={() => onJoinRoom(room.id)}
                        className="w-full px-4 py-3 bg-zinc-800 hover:bg-zinc-700 text-yellow-400 rounded border border-yellow-800 font-mono text-left transition-all">
                        <div className="flex justify-between items-center">
                          <span className="text-lg">{room.id}</span>
                          <span className="text-xs text-yellow-600">{room.players}/2 players</span>
                        </div>
                      </button>
                    ))}
                  </div>
                </div>
              )}
              
              <div className="relative">
                <div className="absolute inset-0 flex items-center">
                  <div className="w-full border-t border-yellow-800"></div>
                </div>
                <div className="relative flex justify-center text-sm">
                  <span className="px-2 bg-zinc-900 text-yellow-600 font-serif">or enter code</span>
                </div>
              </div>
              
              <div>
                <input 
                  type="text" 
                  placeholder="Enter Room ID"
                  value={roomId}
                  onChange={(e) => setRoomId(e.target.value.toUpperCase())}
                  className="w-full px-4 py-3 bg-black text-yellow-400 border-2 border-yellow-800 rounded font-mono text-lg text-center placeholder-yellow-800 focus:border-yellow-600 focus:outline-none"
                  maxLength={6}
                />
                <button 
                  onClick={() => roomId.length === 6 && onJoinRoom(roomId)} 
                  disabled={roomId.length !== 6}
                  className="w-full mt-2 px-6 py-3 bg-gradient-to-r from-yellow-700 to-yellow-800 text-black text-lg font-serif font-bold rounded border-2 border-yellow-600 hover:from-yellow-600 hover:to-yellow-700 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                  🚪 JOIN ROOM
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function RoomWaiting({ roomId, onLeave, onStart, onToggleReady, players, isReady, myReady, opponentReady, playerId, connectionStatus }) {
  const [debugInfo, setDebugInfo] = React.useState('');
  
  const playerSlots = React.useMemo(() => {
    const slots = [null, null];
    players.forEach(p => {
      if (p === 1) slots[0] = 1;
      if (p === 2) slots[1] = 2;
    });
    return slots;
  }, [players]);
  
  React.useEffect(() => {
    const playerCount = players.filter(p => p !== null && p !== undefined).length;
    const info = `
Players: [${players[0]}, ${players[1]}]
Slots: [${playerSlots[0]}, ${playerSlots[1]}]
Count: ${playerCount}
My PlayerId: ${playerId}
My Ready: ${myReady}
Opponent Ready: ${opponentReady}
All Ready: ${isReady}
Connection: ${connectionStatus}
    `;
    setDebugInfo(info);
    console.log('RoomWaiting render:', info);
  }, [players, playerSlots, isReady, myReady, opponentReady, playerId, connectionStatus]);
  
  return (
    <div className="h-screen w-screen flex items-center justify-center bg-gradient-to-br from-zinc-950 via-stone-950 to-zinc-950 p-4">
      <div className="bg-gradient-to-br from-zinc-900 to-black p-10 rounded-lg shadow-2xl max-w-md w-full border-4 border-yellow-700 text-center">
        <button onClick={onLeave} 
          className="mb-4 text-yellow-600 hover:text-yellow-400 font-serif text-sm">
          ← Leave Room
        </button>
        
        <div className="text-5xl mb-4">🎮</div>
        <h2 className="text-3xl font-serif font-black text-yellow-400 mb-4 tracking-wider">ROOM</h2>
        
        <div className="bg-black rounded-lg p-6 mb-6 border-2 border-yellow-800">
          <p className="text-yellow-600 text-sm font-serif mb-2">Room ID</p>
          <p className="text-yellow-400 text-4xl font-mono font-bold tracking-widest">{roomId}</p>
          <p className="text-yellow-700 text-xs font-serif italic mt-2">Share this code with your opponent</p>
          <div className={`mt-3 text-xs font-serif ${connectionStatus === 'connected' ? 'text-green-500' : connectionStatus === 'connecting' ? 'text-yellow-500' : 'text-red-500'}`}>
            {connectionStatus === 'connected' ? '✓ Connected' : connectionStatus === 'connecting' ? '⏳ Connecting...' : '✗ Disconnected'}
          </div>
        </div>
        
        <div className="bg-zinc-800 rounded-lg p-4 mb-6 border-2 border-yellow-900">
          <p className="text-yellow-500 text-sm font-serif mb-3">Players ({players.filter(p => p !== null && p !== undefined).length}/2)</p>
          <div className="space-y-2">
            {playerSlots.map((playerNum, idx) => {
              const hasPlayer = playerNum !== null;
              const isMe = hasPlayer && playerNum === playerId;
              const playerReady = hasPlayer ? (isMe ? myReady : opponentReady) : false;
              
              return (
                <div key={idx} className={`bg-black rounded px-3 py-2 flex items-center justify-between ${!hasPlayer ? 'opacity-50' : ''}`}>
                  <span className={hasPlayer ? 'text-yellow-400 font-serif' : 'text-yellow-600 font-serif'}>
                    Commander {idx + 1} {hasPlayer ? `(P${playerNum})` : ''} {isMe ? '(You)' : ''}
                  </span>
                  <span className={`text-sm ${hasPlayer ? (playerReady ? 'text-green-500' : 'text-yellow-500') : 'text-yellow-700'}`}>
                    {hasPlayer ? (playerReady ? '✓ Ready' : '⏳ Not Ready') : '⏳ Waiting...'}
                  </span>
                </div>
              );
            })}
          </div>
        </div>
        
        <div className="bg-purple-950 rounded-lg p-3 mb-4 border border-purple-800 text-left">
          <p className="text-purple-400 text-xs font-mono whitespace-pre">{debugInfo}</p>
        </div>
        
        <button 
          onClick={onToggleReady}
          disabled={connectionStatus !== 'connected' || players.filter(p => p !== null && p !== undefined).length < 2}
          className={`w-full px-6 py-3 text-lg font-serif font-bold rounded border-2 shadow-lg transition-all mb-3 ${
            myReady 
              ? 'bg-gradient-to-r from-gray-700 to-gray-800 text-gray-300 border-gray-600' 
              : 'bg-gradient-to-r from-yellow-700 to-yellow-800 text-black border-yellow-600 hover:from-yellow-600 hover:to-yellow-700'
          } disabled:opacity-50 disabled:cursor-not-allowed`}>
          {myReady ? '✓ READY (Click to Unready)' : 'READY UP'}
        </button>
        
        {playerId === 1 && (
          <button 
            onClick={onStart}
            disabled={!isReady || connectionStatus !== 'connected'}
            className="w-full px-6 py-3 bg-gradient-to-r from-emerald-700 to-emerald-800 text-white text-lg font-serif font-bold rounded border-2 border-emerald-600 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:from-emerald-600 hover:to-emerald-700">
            ⚔ START BATTLE
          </button>
        )}
        
        <p className="text-xs text-yellow-700 mt-4 italic font-serif">
          {players.filter(p => p !== null && p !== undefined).length < 2 
            ? 'Waiting for second player...'
            : isReady 
              ? (playerId === 1 ? 'Both ready! Click START BATTLE' : 'Both ready! Waiting for host to start...') 
              : 'Both players must click READY UP'}
        </p>
        
        {connectionStatus !== 'connected' && (
          <p className="text-xs text-red-500 mt-2 font-serif">
            Connection issue - Check if server is running on port 8080
          </p>
        )}
      </div>
    </div>
  );
}


    function GameBoard({ board, phase, mode, multiplayerMode, turn, setupPlayer, sel, moves, lastMove, devMode, playerId, onCellClick }) {
      const perspective = phase === 'playing' && mode === '2player' && multiplayerMode === 'local' ? turn : (multiplayerMode === 'online' ? playerId : setupPlayer);
      
      const rows = [];
      for (let r = 0; r < 8; r++) {
        const cells = [];
        for (let c = 0; c < 9; c++) {
          const actualR = perspective === 2 ? 7 - r : r;
          const actualC = perspective === 2 ? 8 - c : c;
          const cell = board[actualR][actualC];
          
          const isSelected = sel?.[0] === actualR && sel?.[1] === actualC;
          const isValidMove = moves.some(([mr, mc]) => mr === actualR && mc === actualC);
          
          let isLastMoveFrom = false;
          let isLastMoveTo = false;
          
          if (lastMove && lastMove.turn !== turn) {
            isLastMoveFrom = lastMove.from[0] === actualR && lastMove.from[1] === actualC;
            isLastMoveTo = lastMove.to[0] === actualR && lastMove.to[1] === actualC;
          }
          
          let canSee = devMode || !cell;
          if (cell && !devMode) {
            if (phase === 'setup') {
              canSee = multiplayerMode === 'online' ? cell.p === playerId : cell.p === setupPlayer;
            } else if (mode === 'ai') {
              canSee = cell.p === 1;
            } else if (multiplayerMode === 'local') {
              canSee = cell.p === turn;
            } else if (multiplayerMode === 'online') {
              canSee = cell.p === playerId;
            } else {
              canSee = true;
            }
          }
          
          cells.push(
            <div
              key={c}
              onClick={() => onCellClick(actualR, actualC)}
              className={`flex items-center justify-center cursor-pointer transition-all ${
                isSelected ? 'bg-yellow-600 shadow-[inset_0_0_20px_rgba(255,215,0,0.6)]' : 
                isValidMove ? 'bg-emerald-700 hover:bg-emerald-600' :
                (isLastMoveFrom || isLastMoveTo) ? 'bg-red-800 hover:bg-red-700' :
                'bg-gradient-to-br from-amber-900 to-yellow-900 hover:from-amber-800 hover:to-yellow-800'
              } ${c === 0 ? 'border-l-2' : ''} ${r === 0 ? 'border-t-2' : ''} border-r-2 border-b-2 border-yellow-700`}
              style={{ flex: 1, aspectRatio: '1/1' }}
            >
              {cell ? (canSee ? (
                <div className="w-full h-full p-[2px] md:p-1">
                  <PieceIcon rank={cell.r} player={cell.p} />
                </div>
              ) : 
                <div className="text-xl md:text-2xl font-serif text-yellow-600">?</div>) : ''}
            </div>
          );
        }
        rows.push(
          <div key={r} className="flex" style={{ flex: 1, minHeight: 0 }}>
            {cells}
          </div>
        );
      }
      return rows;
    }
    function Sidebar({ 
      phase, mode, multiplayerMode, msg, roomId, inventory, defeated, 
      setupPlayer, turn, board, devMode, lastMove, opponentPiecesPlaced,
      onFinishSetup, onAutoSetup, onReset 
    }) {
      return (
        <div className="order-2 flex-shrink-0 lg:flex-initial bg-gradient-to-b from-zinc-900 to-black border-t lg:border-t-0 lg:border-l-4 border-yellow-700 flex flex-col p-2 py-3 lg:p-4 overflow-y-auto max-h-[45vh] lg:max-h-full lg:w-[380px]">
          <div className="text-center mb-2 pb-2 lg:mb-4 lg:pb-4 border-b-2 border-yellow-800">
            <h1 className="text-xl md:text-2xl lg:text-4xl font-serif font-black text-transparent bg-clip-text bg-gradient-to-b from-yellow-400 via-yellow-500 to-yellow-600 tracking-wider">
              IMPERIUM
            </h1>
            <div className="text-[10px] lg:text-xs text-yellow-600 italic mt-0 lg:mt-1 font-serif tracking-widest">SALPAKAN</div>
            {multiplayerMode === 'online' && roomId && (
              <div className="mt-2 bg-black rounded px-3 py-1 border border-yellow-900">
                <span className="text-yellow-600 text-xs font-mono">Room: {roomId}</span>
              </div>
            )}
          </div>
          
          {phase === 'setup' && multiplayerMode === 'online' && opponentPiecesPlaced > 0 && (
            <div className="mb-2 lg:mb-4 px-3 py-2 lg:px-4 lg:py-3 bg-blue-950 rounded border-2 border-blue-900">
              <div className="text-blue-400 text-sm lg:text-base font-serif font-bold">
                Opponent Deploying: <span className="text-blue-300 text-lg lg:text-xl">{opponentPiecesPlaced}</span> / 21
              </div>
            </div>
          )}

          {phase === 'setup' && (
            <>
              <div className="text-center text-base lg:text-lg text-yellow-400 mb-2 lg:mb-4 font-serif font-bold px-3 py-2 lg:px-4 lg:py-3 bg-black rounded border-2 border-yellow-800">
                {msg}
              </div>
              
              <div className="mb-2 lg:mb-4 px-3 py-2 lg:px-4 lg:py-3 bg-zinc-900 rounded border-2 border-yellow-900">
                <div className="text-yellow-500 text-sm lg:text-base font-serif font-bold">
                  Units Remaining: <span className="text-yellow-300 text-lg lg:text-xl">{Object.values(inventory).reduce((sum, count) => sum + count, 0)}</span> / 21
                </div>
              </div>
            </>
          )}
          
          {phase === 'playing' && (
            <>
              <div className="text-center text-base lg:text-lg text-yellow-400 mb-2 lg:mb-4 font-serif font-bold px-3 py-2 lg:px-4 lg:py-3 bg-black rounded border-2 border-yellow-800">
                {msg}
              </div>
            </>
          )}
          
          {devMode && phase === 'playing' && (
            <div className="mb-2 lg:mb-4 px-3 py-2 lg:px-4 lg:py-3 bg-zinc-900 rounded border-2 border-purple-900">
              <div className="text-purple-400 text-[10px] lg:text-xs font-mono">
                <div>Turn: {turn} | View: {phase === 'playing' && mode === '2player' && multiplayerMode === 'local' ? turn : setupPlayer}</div>
                {lastMove && (
                  <div>Last: [{lastMove.from[0]},{lastMove.from[1]}]→[{lastMove.to[0]},{lastMove.to[1]}] T{lastMove.turn}</div>
                )}
                <div>P1: {board.flat().filter(c => c?.p === 1).length} | P2: {board.flat().filter(c => c?.p === 2).length}</div>
              </div>
            </div>
          )}
          
          {(phase === 'setup' || phase === 'playing') && (
            <div className="mb-2 lg:mb-4 space-y-2 lg:space-y-3">
              {phase === 'setup' && (
                <div className="px-3 py-2 lg:px-4 lg:py-3 bg-zinc-900 rounded border-2 border-yellow-900">
                  <div className="text-yellow-500 text-xs lg:text-sm font-serif font-bold mb-1 lg:mb-2">Your Forces:</div>
                  <div className="grid grid-cols-7 gap-1">
                    {RANKS.map(({ r }) => {
                      const count = board.flat().filter(cell => cell?.p === setupPlayer && cell?.r === r).length;
                      return count > 0 ? (
                        <div key={r} className="relative w-7 h-7 lg:w-8 lg:h-8 bg-black rounded border border-yellow-700">
                          <div className="w-full h-full scale-90"><PieceIcon rank={r} player={setupPlayer} /></div>
                          <div className="absolute -top-1 -right-1 bg-green-700 text-white text-[10px] lg:text-xs rounded-full w-3.5 h-3.5 lg:w-4 lg:h-4 flex items-center justify-center font-bold">{count}</div>
                        </div>
                      ) : null;
                    })}
                  </div>
                </div>
              )}
              
              {defeated[phase === 'playing' && mode === '2player' && multiplayerMode === 'local' ? turn : (phase === 'playing' && mode === 'ai' ? 1 : setupPlayer)]?.length > 0 && (
                <div className="px-3 py-2 lg:px-4 lg:py-3 bg-red-950 rounded border-2 border-red-900">
                  <div className="text-red-400 text-xs lg:text-sm font-serif font-bold mb-1 lg:mb-2">Casualties:</div>
                  <div className="grid grid-cols-7 gap-1">
                    {[...new Set(defeated[phase === 'playing' && mode === '2player' && multiplayerMode === 'local' ? turn : (phase === 'playing' && mode === 'ai' ? 1 : setupPlayer)])].map(r => {
                      const count = defeated[phase === 'playing' && mode === '2player' && multiplayerMode === 'local' ? turn : (phase === 'playing' && mode === 'ai' ? 1 : setupPlayer)].filter(dr => dr === r).length;
                      return (
                        <div key={r} className="relative w-7 h-7 lg:w-8 lg:h-8 bg-black rounded border border-red-800 opacity-60">
                          <div className="w-full h-full scale-90 grayscale"><PieceIcon rank={r} player={phase === 'playing' && mode === '2player' && multiplayerMode === 'local' ? turn : (phase === 'playing' && mode === 'ai' ? 1 : setupPlayer)} /></div>
                          <div className="absolute -top-1 -right-1 bg-red-700 text-white text-[10px] lg:text-xs rounded-full w-3.5 h-3.5 lg:w-4 lg:h-4 flex items-center justify-center font-bold">{count}</div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              )}
            </div>
          )}
          
          {phase === 'setup' && (
            <div className="flex flex-col gap-1.5 lg:gap-2 mt-auto">
              <button onClick={onFinishSetup} 
                className="px-3 py-1.5 lg:px-4 lg:py-2 bg-gradient-to-r from-green-700 to-green-800 text-white text-sm lg:text-base font-serif font-bold rounded border-2 border-green-600 hover:from-green-600 hover:to-green-700 shadow-lg">
                {setupPlayer === 1 && mode === '2player' && multiplayerMode === 'local' ? '→ NEXT COMMANDER' : '⚔ BEGIN BATTLE'}
              </button>
              <button onClick={onAutoSetup} 
                className="px-3 py-1.5 lg:px-4 lg:py-2 bg-gradient-to-r from-purple-800 to-purple-900 text-yellow-300 text-sm lg:text-base font-serif font-bold rounded border-2 border-purple-700 hover:from-purple-700 hover:to-purple-800 shadow-lg">
                ⚡ AUTO DEPLOY
              </button>
              <button onClick={onReset} 
                className="px-3 py-1.5 lg:px-4 lg:py-2 bg-gradient-to-r from-red-900 to-red-950 text-yellow-300 text-sm lg:text-base font-serif font-bold rounded border-2 border-red-800 hover:from-red-800 hover:to-red-900 shadow-lg">
                ↻ RESET CAMPAIGN
              </button>
            </div>
          )}
          
          {phase === 'playing' && (
            <div className="flex flex-col gap-1.5 lg:gap-2 mt-auto">
              <button onClick={onReset} 
                className="px-3 py-1.5 lg:px-4 lg:py-2 bg-gradient-to-r from-red-900 to-red-950 text-yellow-300 text-sm lg:text-base font-serif font-bold rounded border-2 border-red-800 hover:from-red-800 hover:to-red-900 shadow-lg">
                ↻ RESET CAMPAIGN
              </button>
            </div>
          )}
        </div>
      );
    }

    function UnitPicker({ inventory, setupPlayer, onSelect, onCancel }) {
      return (
        <div className="fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-50 p-4"
             onClick={onCancel}>
          <div className="bg-gradient-to-br from-zinc-900 to-black p-6 rounded-lg shadow-2xl max-w-lg w-full border-4 border-yellow-700 max-h-[90vh] overflow-y-auto"
               onClick={(e) => e.stopPropagation()}>
            <h2 className="text-2xl font-serif font-black text-yellow-400 mb-4 text-center tracking-wider">SELECT UNIT</h2>
            <div className="grid grid-cols-5 gap-2">
              {RANKS.map(({ r }) => (
                inventory[r] > 0 && (
                  <button
                    key={r}
                    onClick={() => onSelect(r)}
                    className="px-2 py-3 rounded border-2 bg-gradient-to-br from-yellow-700 to-yellow-800 border-yellow-600 hover:from-yellow-600 hover:to-yellow-700 font-serif font-bold text-sm transition-all hover:scale-110 shadow-lg flex flex-col items-center"
                  >
                    <div className="w-full h-12">
                      <PieceIcon rank={r} player={setupPlayer} />
                    </div>
                    <div className="text-xs mt-1 bg-black bg-opacity-50 rounded px-1 text-yellow-300">×{inventory[r]}</div>
                  </button>
                )
              ))}
            </div>
            <button onClick={onCancel} 
                    className="mt-4 w-full px-4 py-2 bg-red-900 text-yellow-300 rounded border-2 border-red-800 hover:bg-red-800 font-serif font-bold">
              CANCEL
            </button>
          </div>
        </div>
      );
    }

    function TurnLockModal({ pausePhase, setupPlayer, mode, multiplayerMode, turn, battleResult, onConfirm }) {
      return (
        <div className="fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-50 p-4">
          <div className="bg-gradient-to-br from-zinc-900 to-black p-10 rounded-lg shadow-2xl max-w-md w-full border-4 border-yellow-700 text-center">
            <div className="text-6xl mb-4">⚔</div>
            <h2 className="text-3xl font-serif font-black text-yellow-400 mb-3 tracking-wider">
              {pausePhase ? (setupPlayer === 1 && mode === '2player' && multiplayerMode === 'local' ? 'COMMANDER 2' : 'BATTLE BEGINS') : `COMMANDER ${turn}`}
            </h2>
            <p className="text-lg text-yellow-600 mb-6 font-serif">
              {pausePhase ? 'Transfer command authority' : (battleResult ? 'Review the battle outcome' : 'Prepare your strategy')}
            </p>
            <button onClick={onConfirm}
                    className="px-8 py-3 bg-gradient-to-r from-yellow-700 to-yellow-800 text-black text-xl rounded border-2 border-yellow-600 font-serif font-bold hover:from-yellow-600 hover:to-yellow-700 shadow-2xl transform hover:scale-105 transition-all w-full">
              READY ✓
            </button>
            <p className="text-xs text-yellow-700 mt-4 italic font-serif">
              Honor demands proper turn order
            </p>
          </div>
        </div>
      );
    }

    function BattleReportModal({ battleResult, showingBattleForPlayer, onContinue }) {
      return (
        <div className="fixed inset-0 bg-black bg-opacity-95 flex items-center justify-center z-50 p-4">
          <div className="bg-gradient-to-br from-zinc-900 to-black p-10 rounded-lg shadow-2xl max-w-md w-full border-4 border-yellow-700 text-center">
            <div className="mb-6 p-4 bg-black rounded border-2 border-yellow-800">
              <div className="text-xl font-serif font-bold text-yellow-400 mb-3">BATTLE REPORT</div>
              <div className="flex items-center justify-center gap-4 mb-2">
                {battleResult.result === 'draw' ? (
                  <>
                    <div className="flex flex-col items-center">
                      <div className="w-16 h-16 mb-1">
                        <PieceIcon rank={showingBattleForPlayer === battleResult.player ? battleResult.attacker : battleResult.defender} player={showingBattleForPlayer} />
                      </div>
                      <div className="text-xs text-yellow-600">Your Unit</div>
                    </div>
                    <div className="text-3xl">⚔</div>
                    <div className="flex flex-col items-center">
                      <div className="w-16 h-16 mb-1">
                        <PieceIcon rank={showingBattleForPlayer === battleResult.player ? battleResult.defender : battleResult.attacker} player={showingBattleForPlayer === 1 ? 2 : 1} />
                      </div>
                      <div className="text-xs text-yellow-600">Enemy Unit</div>
                    </div>
                  </>
                ) : showingBattleForPlayer === battleResult.player ? (
                  <>
                    <div className="flex flex-col items-center">
                      <div className="w-16 h-16 mb-1">
                        <PieceIcon rank={battleResult.attacker} player={battleResult.player} />
                      </div>
                      <div className="text-xs text-yellow-600">Your Unit</div>
                    </div>
                    <div className="text-3xl">⚔</div>
                    <div className="flex flex-col items-center">
                      <div className="w-16 h-16 mb-1 flex items-center justify-center">
                        {(battleResult.attacker === 'SPY' && battleResult.result === 'lose') || 
                         (battleResult.attacker === 'PVT' && battleResult.result === 'lose') ||
                         (battleResult.defender === 'FLAG') ? (
                          <PieceIcon rank={battleResult.defender} player={battleResult.player === 1 ? 2 : 1} />
                        ) : (
                          <div className="text-4xl text-yellow-600">?</div>
                        )}
                      </div>
                      <div className="text-xs text-yellow-600">Enemy</div>
                    </div>
                  </>
                ) : (
                  <>
                    <div className="flex flex-col items-center">
                      <div className="w-16 h-16 mb-1 flex items-center justify-center">
                        {(battleResult.defender === 'SPY' && battleResult.result === 'win') || 
                         (battleResult.defender === 'PVT' && battleResult.result === 'win') ||
                         (battleResult.attacker === 'FLAG') ? (
                          <PieceIcon rank={battleResult.attacker} player={battleResult.player} />
                        ) : (
                          <div className="text-4xl text-yellow-600">?</div>
                        )}
                      </div>
                      <div className="text-xs text-yellow-600">Enemy</div>
                    </div>
                    <div className="text-3xl">⚔</div>
                    <div className="flex flex-col items-center">
                      <div className="w-16 h-16 mb-1">
                        <PieceIcon rank={battleResult.defender} player={battleResult.player === 1 ? 2 : 1} />
                      </div>
                      <div className="text-xs text-yellow-600">Your Unit</div>
                    </div>
                  </>
                )}
              </div>
              <div className={`text-lg font-serif font-bold mt-3 ${
                (showingBattleForPlayer === battleResult.player && battleResult.result === 'win') || (showingBattleForPlayer !== battleResult.player && battleResult.result === 'lose') ? 'text-green-400' : 
                (showingBattleForPlayer === battleResult.player && battleResult.result === 'lose') || (showingBattleForPlayer !== battleResult.player && battleResult.result === 'win') ? 'text-red-400' : 'text-yellow-400'
              }`}>
                {(showingBattleForPlayer === battleResult.player && battleResult.result === 'win') || (showingBattleForPlayer !== battleResult.player && battleResult.result === 'lose') ? '⚔ VICTORY' : 
                 (showingBattleForPlayer === battleResult.player && battleResult.result === 'lose') || (showingBattleForPlayer !== battleResult.player && battleResult.result === 'win') ? '☠ UNIT LOST' : '⚡ MUTUAL ELIMINATION'}
              </div>
            </div>
            
            <button onClick={onContinue}
                    className="px-8 py-3 bg-gradient-to-r from-yellow-700 to-yellow-800 text-black text-xl rounded border-2 border-yellow-600 font-serif font-bold hover:from-yellow-600 hover:to-yellow-700 shadow-2xl transform hover:scale-105 transition-all w-full">
              CONTINUE ✓
            </button>
          </div>
        </div>
      );
    }
    
    
    function Salpakan() {
      const playerIdRef = React.useRef(null);
  const [screen, setScreen] = useState('home');
  const [board, setBoard] = useState(GameLogic.initBoard());
  const [phase, setPhase] = useState('setup');
  const [mode, setMode] = useState(null);
  const [turn, setTurn] = useState(1);
  const [sel, setSel] = useState(null);
  const [moves, setMoves] = useState([]);
  const [msg, setMsg] = useState('Choose Mode');
  const [devMode, setDevMode] = useState(false);
  const [setupPlayer, setSetupPlayer] = useState(1);
  const [inventory, setInventory] = useState({});
  const [showPicker, setShowPicker] = useState(null);
  const [showTurnLock, setShowTurnLock] = useState(false);
  const [pausePhase, setPausePhase] = useState(false);
  const [battleResult, setBattleResult] = useState(null);
  const [defeated, setDefeated] = useState({ 1: [], 2: [] });
  const [showBattleReport, setShowBattleReport] = useState(false);
  const [lastMove, setLastMove] = useState(null);
  const [showingBattleForPlayer, setShowingBattleForPlayer] = useState(null);
  const [roomId, setRoomId] = useState('');
  const [multiplayerMode, setMultiplayerMode] = useState(null);
  const [playerId, setPlayerId] = useState(null);
  const [players, setPlayers] = useState([null, null]);
  const [isRoomReady, setIsRoomReady] = useState(false);
  const [myReadyState, setMyReadyState] = useState(false);
  const [opponentReadyState, setOpponentReadyState] = useState(false);
  const [opponentBoard, setOpponentBoard] = useState(null);
  const [availableRooms, setAvailableRooms] = useState([]);
  const [connectionStatus, setConnectionStatus] = useState('disconnected');
  const [opponentPiecesPlaced, setOpponentPiecesPlaced] = useState(0);

  useEffect(() => {
    console.log('Salpakan game initialized');
    console.log('Current screen:', screen);
  }, []);

useEffect(() => {
  if (screen === 'multiplayer') {
    console.log('Multiplayer screen - connecting for room list');
    
    const host = window.location.hostname;
    const roomListWs = new WebSocket(`ws://${host}:8080`);
    
    roomListWs.onopen = () => {
      console.log('Room list WebSocket connected');
      roomListWs.send(JSON.stringify({ type: 'getRooms' }));
    };

    roomListWs.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'roomList') {
        console.log('Received room list:', data.rooms);
        setAvailableRooms(data.rooms.filter(room => !room.isFull));
      }
    };

    roomListWs.onerror = (error) => {
      console.error('Room list WebSocket error:', error);
    };

    const interval = setInterval(() => {
      if (roomListWs.readyState === WebSocket.OPEN) {
        roomListWs.send(JSON.stringify({ type: 'getRooms' }));
      }
    }, 2000);

    return () => {
      console.log('Closing room list WebSocket');
      clearInterval(interval);
      roomListWs.close(); 
    };
  } else if (screen === 'room') {
    console.log('Room screen - ensuring clean WebSocket state');
  }
}, [screen]);

useEffect(() => {
  if ((screen === 'room' || screen === 'onlineGame') && roomId) {
    console.log('=== INITIALIZING ROOM WEBSOCKET ===');
    console.log('Room ID:', roomId);
    console.log('Current screen:', screen);
    
    const handleRoomJoined = (data) => {
      console.log('=== handleRoomJoined TRIGGERED ===');
      console.log('Received data:', JSON.stringify(data));
      console.log('Setting playerId to:', data.playerId);
      
      const myId = data.playerId;
      
      playerIdRef.current = myId;
      setPlayerId(myId);
      
      console.log('PlayerIdRef.current after setting:', playerIdRef.current);
      
      const normalizedPlayers = [null, null];
      data.players.forEach(p => {
        if (p === 1) normalizedPlayers[0] = 1;
        if (p === 2) normalizedPlayers[1] = 2;
      });
      setPlayers(normalizedPlayers);
      setConnectionStatus('connected');
      
      const myReady = data.readyStates ? data.readyStates[myId] || false : false;
      const opponentId = myId === 1 ? 2 : 1;
      const oppReady = data.readyStates ? data.readyStates[opponentId] || false : false;
      
      console.log('Setting ready states - My:', myReady, 'Opponent:', oppReady);
      
      setMyReadyState(myReady);
      setOpponentReadyState(oppReady);
      setIsRoomReady(myReady && oppReady);
    };

    const handlePlayerJoined = (data) => {
      console.log('=== handlePlayerJoined TRIGGERED ===');
      console.log('Current playerIdRef.current:', playerIdRef.current);
      console.log('Received data:', JSON.stringify(data));
      
      const normalizedPlayers = [null, null];
      data.players.forEach(p => {
        if (p === 1) normalizedPlayers[0] = 1;
        if (p === 2) normalizedPlayers[1] = 2;
      });
      setPlayers(normalizedPlayers);
      
      const currentPlayerId = playerIdRef.current;
      console.log('Using playerId from ref:', currentPlayerId);
      
      if (data.readyStates && currentPlayerId) {
        const myReady = data.readyStates[currentPlayerId] || false;
        const opponentId = currentPlayerId === 1 ? 2 : 1;
        const oppReady = data.readyStates[opponentId] || false;
        
        console.log('Updating ready states - My:', myReady, 'Opponent:', oppReady);
        
        setMyReadyState(myReady);
        setOpponentReadyState(oppReady);
        setIsRoomReady(myReady && oppReady);
      } else {
        console.warn('Cannot update ready states - playerId not set or no readyStates data');
      }
    };

    const handlePlayerReady = (data) => {
      console.log('=== playerReady EVENT RECEIVED ===');
      console.log('Full data:', JSON.stringify(data));
      
      const currentPlayerId = playerIdRef.current;
      
      if (!currentPlayerId) {
        console.error('ERROR: No playerId set!');
        return;
      }
      
      if (data.readyStates) {
        const opponentId = currentPlayerId === 1 ? 2 : 1;
        const myReady = data.readyStates[currentPlayerId] === true;
        const oppReady = data.readyStates[opponentId] === true;
        
        console.log(`Updating states - My(${currentPlayerId}): ${myReady}, Opp(${opponentId}): ${oppReady}, AllReady: ${data.allReady}`);
        
        setMyReadyState(myReady);
        setOpponentReadyState(oppReady);
        setIsRoomReady(data.allReady === true);
      }
    };

const handleGameStart = (data) => {
  console.log('=== handleGameStart TRIGGERED ===');
  console.log('Game starting with data:', JSON.stringify(data));
  
  setMode('2player');
  setMultiplayerMode('online');
  setBoard(GameLogic.initBoard());
  const inv = {};
  RANKS.forEach(({ r, count }) => { inv[r] = count; });
  setInventory(inv);
  setSetupPlayer(playerIdRef.current);
  setPhase('setup');
  setMsg('Deploy Your Forces');
  setScreen('onlineGame');
};

    const handleOpponentDeploymentUpdate = (data) => {
      console.log('=== handleOpponentDeploymentUpdate TRIGGERED ===');
      const currentPlayerId = playerIdRef.current;
      console.log('Current playerId:', currentPlayerId);
      console.log('Opponent pieces placed:', data.piecesPlaced);
      
      setOpponentPiecesPlaced(data.piecesPlaced);
      
      if (data.board && currentPlayerId) {
        setBoard(prevBoard => {
          const mergedBoard = prevBoard.map((row, r) => 
            row.map((cell, c) => {
              if (data.board[r][c] && data.board[r][c].p !== currentPlayerId) {
                return data.board[r][c];
              }
              return cell;
            })
          );
          return mergedBoard;
        });
      }
    };

    const handleOpponentSetupComplete = (data) => {
      console.log('=== handleOpponentSetupComplete TRIGGERED ===');
      const currentPlayerId = playerIdRef.current;
      console.log('Current playerId:', currentPlayerId, 'Setup complete playerId:', data.playerId);
      
      if (data.playerId !== currentPlayerId) {
        setMsg('Opponent ready! Finish your deployment.');
      }
    };

    const handleBothPlayersReady = (data) => {
      console.log('=== handleBothPlayersReady TRIGGERED ===');
      const currentPlayerId = playerIdRef.current;
      console.log('Both players ready, starting game. My playerId:', currentPlayerId);
      
      setPhase('playing');
      setTurn(1);
      setMsg(currentPlayerId === 1 ? 'Your Turn' : 'Opponent Turn');
      setOpponentPiecesPlaced(0);
    };

    const handleMove = (data) => {
      console.log('=== handleMove TRIGGERED ===');
      const currentPlayerId = playerIdRef.current;
      console.log('Move by player:', data.playerId, 'My playerId:', currentPlayerId);
      
      if (data.playerId !== currentPlayerId) {
        setBoard(data.board);
        setTurn(data.turn);
        setLastMove(data.lastMove);
        setDefeated(data.defeated);
        
        if (data.turn === currentPlayerId) {
          setMsg('Your Turn');
        } else {
          setMsg('Opponent Turn');
        }
        
        if (data.battleResult) {
          setBattleResult(data.battleResult);
          setShowBattleReport(true);
        }
      }
    };

    const handleGameEnd = (data) => {
      console.log('=== handleGameEnd TRIGGERED ===');
      console.log('Game ended:', JSON.stringify(data));
      setMsg(data.message);
      setPhase('ended');
    };

    if (screen === 'room') {
      WebSocketManager.disconnect();
      
      console.log('Registering all WebSocket handlers...');
      WebSocketManager.on('roomJoined', handleRoomJoined);
      WebSocketManager.on('playerJoined', handlePlayerJoined);
      WebSocketManager.on('playerReady', handlePlayerReady);
      WebSocketManager.on('gameStart', handleGameStart);
      WebSocketManager.on('opponentDeploymentUpdate', handleOpponentDeploymentUpdate);
      WebSocketManager.on('opponentSetupComplete', handleOpponentSetupComplete);
      WebSocketManager.on('bothPlayersReady', handleBothPlayersReady);
      WebSocketManager.on('move', handleMove);
      WebSocketManager.on('gameEnd', handleGameEnd);
      
      console.log('All handlers registered. Callbacks:', Object.keys(WebSocketManager.callbacks));
      
      console.log('Connecting to WebSocket for room:', roomId);
      WebSocketManager.connect(roomId, null);
    } else if (screen === 'onlineGame') {
      console.log('Already connected, re-registering handlers for onlineGame screen...');
      WebSocketManager.on('gameStart', handleGameStart);
      WebSocketManager.on('opponentDeploymentUpdate', handleOpponentDeploymentUpdate);
      WebSocketManager.on('opponentSetupComplete', handleOpponentSetupComplete);
      WebSocketManager.on('bothPlayersReady', handleBothPlayersReady);
      WebSocketManager.on('move', handleMove);
      WebSocketManager.on('gameEnd', handleGameEnd);
    }

    return () => {
      if (screen !== 'room' && screen !== 'onlineGame') {
        console.log('=== CLEANING UP ROOM WEBSOCKET ===');
        WebSocketManager.disconnect();
      }
    };
  }
}, [screen, roomId]);

  const resetGame = useCallback(() => {
    setScreen('home');
    setBoard(GameLogic.initBoard());
    setPhase('setup');
    setMode(null);
    setMultiplayerMode(null);
    setMsg('Choose Mode');
    setInventory({});
    setSel(null);
    setMoves([]);
    setShowPicker(null);
    setShowTurnLock(false);
    setDefeated({ 1: [], 2: [] });
    setBattleResult(null);
    setLastMove(null);
    setShowingBattleForPlayer(null);
    setShowBattleReport(false);
    setRoomId('');
    setPlayerId(null);
    setPlayers([null, null]);
    setIsRoomReady(false);
    setMyReadyState(false);
    setOpponentReadyState(false);
    WebSocketManager.disconnect();
  }, []);

  const startSetup = (m, mp = null) => {
    setMode(m);
    setMultiplayerMode(mp);
    setBoard(GameLogic.initBoard());
    const inv = {};
    RANKS.forEach(({ r, count }) => { inv[r] = count; });
    setInventory(inv);
    setSetupPlayer(1);
    setPhase('setup');
    setMsg('Deploy Your Forces');
    setScreen('game');
  };

  const finishSetup = () => {
    const totalPieces = Object.values(inventory).reduce((sum, count) => sum + count, 0);
    if (totalPieces > 0) {
      setMsg('Deploy All Units!');
      return;
    }

    if (multiplayerMode === 'online') {
      console.log('Sending setup complete for player', playerId);
      WebSocketManager.send({
        type: 'setupComplete',
        roomId,
        playerId,
        board
      });
      setMsg('Waiting for opponent...');
    } else if (setupPlayer === 1 && mode === '2player' && multiplayerMode === 'local') {
      setShowTurnLock(true);
      setPausePhase(true);
    } else if (setupPlayer === 1 && mode === 'ai') {
      const nb = GameLogic.autoSetup(board, 2);
      setBoard(nb);
      setPhase('playing');
      setTurn(1);
      setMsg('Engage the Enemy');
    } else {
      setPhase('playing');
      setTurn(1);
      setShowTurnLock(true);
      setPausePhase(true);
    }
  };

  const confirmTurn = () => {
    if (showBattleReport) {
      setShowBattleReport(false);
      
      if (showingBattleForPlayer && turn === showingBattleForPlayer && showingBattleForPlayer === battleResult.player) {
        const nextTurn = turn === 1 ? 2 : 1;
        setTurn(nextTurn);
        setShowingBattleForPlayer(nextTurn);
        setShowTurnLock(true);
      } else if (showingBattleForPlayer && turn === showingBattleForPlayer && showingBattleForPlayer !== battleResult.player) {
        setShowingBattleForPlayer(null);
        setBattleResult(null);
        setShowTurnLock(false);
      }
      return;
    }
    
    if (pausePhase && setupPlayer === 1 && mode === '2player' && multiplayerMode === 'local') {
      setSetupPlayer(2);
      const inv = {};
      RANKS.forEach(({ r, count }) => { inv[r] = count; });
      setInventory(inv);
      setMsg('Deploy Your Forces');
      setShowTurnLock(false);
      setPausePhase(false);
    } else if (pausePhase && phase === 'setup') {
      setPhase('playing');
      setTurn(1);
      setMsg('Imperium Commander 1');
      setShowTurnLock(false);
      setPausePhase(false);
    } else if (battleResult && showingBattleForPlayer !== null) {
      setShowTurnLock(false);
      setShowBattleReport(true);
    } else {
      setShowTurnLock(false);
    }
  };

  const placeOnBoard = (r, c, rank) => {
    if (board[r][c]) return;
    const nb = board.map(row => [...row]);
    const currentPlayer = multiplayerMode === 'online' ? playerId : setupPlayer;
    nb[r][c] = { r: rank, p: currentPlayer, id: currentPlayer * 100 + Math.random() };
    setBoard(nb);
    setInventory({ ...inventory, [rank]: inventory[rank] - 1 });
    setShowPicker(null);
    
    if (multiplayerMode === 'online') {
      const piecesPlaced = nb.flat().filter(cell => cell?.p === playerId).length;
      WebSocketManager.send({
        type: 'deploymentUpdate',
        roomId,
        playerId,
        piecesPlaced,
        board: nb
      });
    }
  };

  const removeFromBoard = (r, c) => {
    const piece = board[r][c];
    const currentPlayer = multiplayerMode === 'online' ? playerId : setupPlayer;
    if (!piece || piece.p !== currentPlayer) return;
    const nb = board.map(row => [...row]);
    nb[r][c] = null;
    setBoard(nb);
    setInventory({ ...inventory, [piece.r]: inventory[piece.r] + 1 });
    
    if (multiplayerMode === 'online') {
      const piecesPlaced = nb.flat().filter(cell => cell?.p === playerId).length;
      WebSocketManager.send({
        type: 'deploymentUpdate',
        roomId,
        playerId,
        piecesPlaced,
        board: nb
      });
    }
  };

  const handleSetupClick = (r, c) => {
    const currentPlayer = multiplayerMode === 'online' ? playerId : setupPlayer;
    const allowedRows = currentPlayer === 1 ? [7, 6, 5] : [0, 1, 2];
    if (!allowedRows.includes(r)) return;
    
    if (board[r][c]) {
      removeFromBoard(r, c);
    } else {
      setShowPicker([r, c]);
    }
  };

  const handlePlayClick = (r, c) => {
    if (mode === 'ai' && turn !== 1) return;
    if (multiplayerMode === 'online' && turn !== playerId) return;
    
    if (!sel) {
      if (board[r][c]?.p === turn) {
        setSel([r, c]);
        setMoves(GameLogic.validMoves(board, r, c));
      }
    } else {
      const [sr, sc] = sel;
      const validMove = moves.some(([mr, mc]) => mr === r && mc === c);
      
      if (validMove) {
        setLastMove(null);
        
        const nb = board.map(row => [...row]);
        const attacker = nb[sr][sc];
        const defender = nb[r][c];
        const newDefeated = { ...defeated };
        
        if (defender) {
          const res = GameLogic.battle(attacker, defender);
          
          if (res === 'win') {
            nb[r][c] = attacker;
            nb[sr][sc] = null;
            newDefeated[defender.p] = [...newDefeated[defender.p], defender.r];
            setBattleResult({ attacker: attacker.r, defender: defender.r, result: 'win', player: turn });
            
            if (defender.r === 'FLAG') {
              setMsg(`Victory - Commander ${turn}!`);
              setBoard(nb);
              setMoves([]);
              setSel(null);
              setDefeated(newDefeated);
              setPhase('ended');
              if (multiplayerMode === 'online') {
                WebSocketManager.send({
                  type: 'gameEnd',
                  roomId,
                  winner: turn,
                  message: `Victory - Commander ${turn}!`
                });
              }
              return;
            }
          } else if (res === 'lose') {
            nb[sr][sc] = null;
            newDefeated[attacker.p] = [...newDefeated[attacker.p], attacker.r];
            setBattleResult({ attacker: attacker.r, defender: defender.r, result: 'lose', player: turn });
            
            if (attacker.r === 'FLAG') {
              const winner = turn === 1 ? 2 : 1;
              setMsg(`Victory - Commander ${winner}!`);
              setBoard(nb);
              setMoves([]);
              setSel(null);
              setDefeated(newDefeated);
              setPhase('ended');
              if (multiplayerMode === 'online') {
                WebSocketManager.send({
                  type: 'gameEnd',
                  roomId,
                  winner,
                  message: `Victory - Commander ${winner}!`
                });
              }
              return;
            }
          } else {
            nb[r][c] = null;
            nb[sr][sc] = null;
            newDefeated[attacker.p] = [...newDefeated[attacker.p], attacker.r];
            newDefeated[defender.p] = [...newDefeated[defender.p], defender.r];
            setBattleResult({ attacker: attacker.r, defender: defender.r, result: 'draw', player: turn });
          }
          setDefeated(newDefeated);
        } else {
          nb[r][c] = attacker;
          nb[sr][sc] = null;
        }
        
        setBoard(nb);
        setSel(null);
        setMoves([]);

        if (multiplayerMode === 'online') {
          WebSocketManager.send({
            type: 'move',
            roomId,
            playerId,
            board: nb,
            turn: turn === 1 ? 2 : 1,
            lastMove: { from: [sr, sc], to: [r, c], turn },
            battleResult: defender ? battleResult : null,
            defeated: newDefeated
          });
          setTurn(turn === 1 ? 2 : 1);
        } else if (mode === 'ai') {
          setTurn(2);
          setMsg('Enemy Calculating...');
          const currentDefeated = { ...newDefeated };
          setTimeout(() => {
            const aiM = GameLogic.aiMove(nb);
            if (!aiM) { 
              setMsg('Imperial Victory!'); 
              setTurn(1);
              return; 
            }
            
            const nb2 = nb.map(row => [...row]);
            const [ar, ac] = aiM.from;
            const [tr, tc] = aiM.to;
            const aiA = nb2[ar][ac];
            
            if (!aiA) {
              setTurn(1);
              setMsg('Engage the Enemy');
              return;
            }
            
            const def = nb2[tr][tc];
            const newDefeated2 = { ...currentDefeated };
            
            if (def) {
              const res = GameLogic.battle(aiA, def);
              if (res === 'win') {
                nb2[tr][tc] = aiA;
                nb2[ar][ac] = null;
                newDefeated2[def.p] = [...newDefeated2[def.p], def.r];
                if (def.r === 'FLAG') { 
                  setMsg('Defeat - Enemy Prevails'); 
                  setBoard(nb2); 
                  setDefeated(newDefeated2); 
                  setPhase('ended');
                  return; 
                }
              } else if (res === 'lose') {
                nb2[ar][ac] = null;
                newDefeated2[aiA.p] = [...newDefeated2[aiA.p], aiA.r];
              } else {
                nb2[tr][tc] = null;
                nb2[ar][ac] = null;
                newDefeated2[aiA.p] = [...newDefeated2[aiA.p], aiA.r];
                newDefeated2[def.p] = [...newDefeated2[def.p], def.r];
              }
            } else {
              nb2[tr][tc] = aiA;
              nb2[ar][ac] = null;
            }
            
            setBoard(nb2);
            setDefeated(newDefeated2);
            setLastMove({ from: [ar, ac], to: [tr, tc], turn: 2 });
            setTurn(1);
            setMsg('Engage the Enemy');
          }, 300);
        } else if (multiplayerMode === 'local') {
          setLastMove({ from: [sr, sc], to: [r, c], turn: turn });
          
          if (defender) {
            setShowBattleReport(true);
            setShowingBattleForPlayer(turn);
          } else {
            const nextTurn = turn === 1 ? 2 : 1;
            setTurn(nextTurn);
            setShowTurnLock(true);
          }
        }
      } else {
        setSel(null);
        setMoves([]);
      }
    }
  };

  const handleCellClick = (r, c) => {
    if (phase === 'setup') {
      handleSetupClick(r, c);
    } else if (phase === 'playing') {
      handlePlayClick(r, c);
    }
  };

  const handleAutoSetup = () => {
    const currentPlayer = multiplayerMode === 'online' ? playerId : setupPlayer;
    const freshBoard = board.map(row => [...row]);
    const nb = GameLogic.autoSetup(freshBoard, currentPlayer);
    setBoard(nb);
    const inv = {};
    RANKS.forEach(({ r }) => { inv[r] = 0; });
    setInventory(inv);
    
    if (multiplayerMode === 'online') {
      WebSocketManager.send({
        type: 'deploymentUpdate',
        roomId,
        playerId,
        piecesPlaced: 21,
        board: nb
      });
    }
  };
const createRoom = () => {
  const newRoomId = Math.random().toString(36).substring(2, 8).toUpperCase();
  setRoomId(newRoomId);
  setConnectionStatus('connecting');
  setPlayers([null, null]);
  setIsRoomReady(false);
  setMyReadyState(false);
  setOpponentReadyState(false);
  setScreen('room');
};

const joinRoom = (id) => {
  setRoomId(id);
  setConnectionStatus('connecting');
  setPlayers([null, null]);
  setIsRoomReady(false);
  setMyReadyState(false);
  setOpponentReadyState(false);
  setScreen('room');
};

const toggleReady = () => {
  const newReadyState = !myReadyState;
  const currentPlayerId = playerIdRef.current || playerId;
  
  console.log('=== TOGGLE READY CLICKED ===');
  console.log('Current ready state:', myReadyState);
  console.log('New ready state:', newReadyState);
  console.log('PlayerId from ref:', playerIdRef.current);
  console.log('PlayerId from state:', playerId);
  console.log('Using playerId:', currentPlayerId);
  
  if (!currentPlayerId) {
    console.error('ERROR: Cannot toggle ready - no playerId set!');
    return;
  }
  
  setMyReadyState(newReadyState);
  
  const message = {
    type: 'toggleReady',
    roomId,
    playerId: currentPlayerId,
    isReady: newReadyState
  };
  
  console.log('Sending WebSocket message:', message);
  WebSocketManager.send(message);
};

const startOnlineGame = () => {
  if (!isRoomReady) {
    console.log('Cannot start game - room not ready');
    return;
  }
  console.log('Starting online game...');
  WebSocketManager.send({
    type: 'startGame',
    roomId
  });
  
  setMode('2player');
  setMultiplayerMode('online');
  setBoard(GameLogic.initBoard());
  const inv = {};
  RANKS.forEach(({ r, count }) => { inv[r] = count; });
  setInventory(inv);
  setSetupPlayer(playerId);
  setPhase('setup');
  setMsg('Deploy Your Forces');
  setScreen('onlineGame');
};


  if (screen === 'home') {
    return <HomeScreen 
      onModeSelect={(m, mp) => m === 'multiplayer' ? setScreen('multiplayer') : startSetup(m, mp)} 
      devMode={devMode} 
      setDevMode={setDevMode} 
    />;
  }

  if (screen === 'multiplayer') {
    return <MultiplayerLobby 
      onBack={() => setScreen('home')} 
      onCreateRoom={createRoom}
      onJoinRoom={joinRoom}
      roomId={roomId}
      setRoomId={setRoomId}
      availableRooms={availableRooms}
    />;
  }

  if (screen === 'room') {
    return <RoomWaiting 
      roomId={roomId}
      onLeave={() => { 
        setScreen('multiplayer'); 
        setRoomId(''); 
        setPlayerId(null);
        setPlayers([null, null]);
        setConnectionStatus('disconnected'); 
        setMyReadyState(false); 
        setOpponentReadyState(false); 
        setIsRoomReady(false);
        WebSocketManager.disconnect(); 
      }}
      onStart={startOnlineGame}
      onToggleReady={toggleReady}
      players={players}
      isReady={isRoomReady}
      myReady={myReadyState}
      opponentReady={opponentReadyState}
      playerId={playerId}
      connectionStatus={connectionStatus}
    />;
  }

  if (screen === 'onlineGame') {
  return (
    <div className="h-screen w-screen flex flex-col lg:flex-row bg-black overflow-hidden">
      <div className="order-1 flex-1 flex items-center justify-center p-1 md:p-2 bg-gradient-to-br from-zinc-950 via-stone-950 to-zinc-950 min-h-0">
        <div className="w-full h-full max-w-[min(98vw,calc(98vh*1.125))] max-h-[min(98vw/1.125,98vh)] lg:max-w-[min(98vw,calc(98vh*1.125))] lg:max-h-[min(98vw/1.125,98vh)] flex flex-col rounded-lg shadow-[0_0_40px_rgba(212,175,55,0.3)] overflow-hidden border-4 border-yellow-700">
          <GameBoard 
            board={board}
            phase={phase}
            mode={mode}
            multiplayerMode={multiplayerMode}
            turn={turn}
            setupPlayer={playerId}
            sel={sel}
            moves={moves}
            lastMove={lastMove}
            devMode={devMode}
            playerId={playerId}
            onCellClick={handleCellClick}
          />
        </div>
      </div>

      <Sidebar 
        phase={phase}
        mode={mode}
        multiplayerMode={multiplayerMode}
        msg={msg}
        roomId={roomId}
        inventory={inventory}
        defeated={defeated}
        setupPlayer={playerId}
        turn={turn}
        board={board}
        devMode={devMode}
        lastMove={lastMove}
        opponentPiecesPlaced={opponentPiecesPlaced}
        onFinishSetup={finishSetup}
        onAutoSetup={handleAutoSetup}
        onReset={resetGame}
      />

      {showPicker && (
        <UnitPicker 
          inventory={inventory}
          setupPlayer={playerId}
          onSelect={(rank) => placeOnBoard(showPicker[0], showPicker[1], rank)}
          onCancel={() => setShowPicker(null)}
        />
      )}

      {showBattleReport && battleResult && (
        <BattleReportModal 
          battleResult={battleResult}
          showingBattleForPlayer={showingBattleForPlayer}
          onContinue={confirmTurn}
        />
      )}

      {showTurnLock && (
        <TurnLockModal 
          pausePhase={pausePhase}
          setupPlayer={setupPlayer}
          mode={mode}
          multiplayerMode={multiplayerMode}
          turn={turn}
          battleResult={battleResult}
          onConfirm={confirmTurn}
        />
      )}
    </div>
  );
}

  return (
    <div className="h-screen w-screen flex flex-col lg:flex-row bg-black overflow-hidden">
      <div className="order-1 flex-1 flex items-center justify-center p-1 md:p-2 bg-gradient-to-br from-zinc-950 via-stone-950 to-zinc-950 min-h-0">
        <div className="w-full h-full max-w-[min(98vw,calc(98vh*1.125))] max-h-[min(98vw/1.125,98vh)] lg:max-w-[min(98vw,calc(98vh*1.125))] lg:max-h-[min(98vw/1.125,98vh)] flex flex-col rounded-lg shadow-[0_0_40px_rgba(212,175,55,0.3)] overflow-hidden border-4 border-yellow-700">
          <GameBoard 
            board={board}
            phase={phase}
            mode={mode}
            multiplayerMode={multiplayerMode}
            turn={turn}
            setupPlayer={multiplayerMode === 'online' ? playerId : setupPlayer}
            sel={sel}
            moves={moves}
            lastMove={lastMove}
            devMode={devMode}
            playerId={playerId}
            onCellClick={handleCellClick}
          />
        </div>
      </div>

      <Sidebar 
        phase={phase}
        mode={mode}
        multiplayerMode={multiplayerMode}
        msg={msg}
        roomId={roomId}
        inventory={inventory}
        defeated={defeated}
        setupPlayer={setupPlayer}
        turn={turn}
        board={board}
        devMode={devMode}
        lastMove={lastMove}
        opponentPiecesPlaced={opponentPiecesPlaced}
        onFinishSetup={finishSetup}
        onAutoSetup={handleAutoSetup}
        onReset={resetGame}
      />

      {showPicker && (
        <UnitPicker 
          inventory={inventory}
          setupPlayer={multiplayerMode === 'online' ? playerId : setupPlayer}
          onSelect={(rank) => placeOnBoard(showPicker[0], showPicker[1], rank)}
          onCancel={() => setShowPicker(null)}
        />
      )}

      {showBattleReport && battleResult && (
        <BattleReportModal 
          battleResult={battleResult}
          showingBattleForPlayer={showingBattleForPlayer}
          onContinue={confirmTurn}
        />
      )}

      {showTurnLock && (
        <TurnLockModal 
          pausePhase={pausePhase}
          setupPlayer={setupPlayer}
          mode={mode}
          multiplayerMode={multiplayerMode}
          turn={turn}
          battleResult={battleResult}
          onConfirm={confirmTurn}
        />
      )}
    </div>
  );
}
    ReactDOM.render(
      <React.StrictMode>
        <Salpakan />
      </React.StrictMode>, 
      document.getElementById('root'),
      () => console.log('React app mounted successfully')
    );

    window.onerror = function(msg, url, lineNo, columnNo, error) {
      console.error('Global error:', msg, 'at', url, lineNo, columnNo, error);
      return false;
    };
  </script>
</body>
</html>