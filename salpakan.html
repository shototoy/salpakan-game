<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game of the Generals</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const RANKS = [
      { r: '5★', count: 1, img: '5_star' }, { r: '4★', count: 1, img: '4_star' }, { r: '3★', count: 1, img: '3_star' }, 
      { r: '2★', count: 1, img: '2_star' }, { r: '1★', count: 1, img: '1_star' },
      { r: 'COL', count: 1, img: 'colonel' }, { r: 'LTC', count: 1, img: 'ltc' }, { r: 'MAJ', count: 1, img: 'major' }, 
      { r: 'CPT', count: 1, img: 'captain' },
      { r: '1LT', count: 1, img: '1lt' }, { r: '2LT', count: 1, img: '2lt' }, { r: 'SGT', count: 2, img: 'sergeant' }, 
      { r: 'PVT', count: 6, img: 'private' },
      { r: 'SPY', count: 2, img: 'spy' }, { r: 'FLAG', count: 1, img: 'flag' }
    ];

    const POWER = {
      '5★': 15, '4★': 14, '3★': 13, '2★': 12, '1★': 11, 'COL': 10, 'LTC': 9, 'MAJ': 8, 'CPT': 7,
      '1LT': 6, '2LT': 5, 'SGT': 4, 'PVT': 2, 'SPY': 1, 'FLAG': 0
    };

    const createPieces = (p) => {
      const pieces = [];
      let id = 0;
      RANKS.forEach(({ r, count }) => {
        for (let i = 0; i < count; i++) {
          pieces.push({ r, p, id: p * 100 + id++ });
        }
      });
      return pieces;
    };

    const initBoard = () => Array(8).fill(null).map(() => Array(9).fill(null));

    const autoSetup = (b, p) => {
      const nb = b.map(row => [...row]);
      const pieces = createPieces(p).sort(() => Math.random() - 0.5);
      const rows = p === 1 ? [7, 6, 5] : [0, 1, 2];
      let idx = 0;
      for (const r of rows) {
        for (let c = 0; c < 9; c++) {
          if (idx < 21) nb[r][c] = pieces[idx++];
        }
      }
      return nb;
    };

    const battle = (a, d) => {
      if (a.r === 'FLAG' || d.r === 'FLAG') return a.r === 'FLAG' ? 'lose' : 'win';
      if (a.r === 'SPY') return d.r === '5★' ? 'win' : 'lose';
      if (d.r === 'SPY') return a.r === 'PVT' ? 'win' : 'lose';
      return POWER[a.r] > POWER[d.r] ? 'win' : POWER[a.r] < POWER[d.r] ? 'lose' : 'draw';
    };

    const validMoves = (b, r, c) => {
      const dirs = [[-1, 0], [1, 0], [0, -1], [0, 1]];
      return dirs.map(([dr, dc]) => [r + dr, c + dc])
        .filter(([nr, nc]) => nr >= 0 && nr < 8 && nc >= 0 && nc < 9 && (!b[nr][nc] || b[nr][nc].p !== b[r][c].p));
    };

    const aiMove = (b) => {
      const pieces = [];
      for (let r = 0; r < 8; r++) {
        for (let c = 0; c < 9; c++) {
          if (b[r][c]?.p === 2) pieces.push([r, c]);
        }
      }
      const moves = [];
      pieces.forEach(([r, c]) => {
        validMoves(b, r, c).forEach(to => {
          let score = Math.random() * 10;
          const piece = b[r][c];
          if (b[to[0]][to[1]]) {
            const result = battle(piece, b[to[0]][to[1]]);
            score += result === 'win' ? 50 : result === 'draw' ? 20 : -30;
          }
          if (to[0] === 7) score += 30;
          if (piece.r === 'FLAG') score -= 50;
          moves.push({ from: [r, c], to, score });
        });
      });
      moves.sort((a, b) => b.score - a.score);
      return moves.length > 0 ? { from: moves[0].from, to: moves[0].to } : null;
    };

    function PieceIcon({ rank, player, size = 'md' }) {
      const [hasImage, setHasImage] = useState(false);
      const rankData = RANKS.find(r => r.r === rank);
      const imgPath = `./assets/${rankData?.img}.svg`;
      
      useEffect(() => {
        const img = new Image();
        img.onload = () => setHasImage(true);
        img.onerror = () => setHasImage(false);
        img.src = imgPath;
      }, [imgPath]);

      const sizeClass = size === 'sm' ? 'text-sm' : size === 'lg' ? 'text-2xl' : 'text-base';
      const imgSize = size === 'sm' ? 'w-8 h-8' : size === 'lg' ? 'w-16 h-16' : 'w-12 h-12';

      if (hasImage) {
        return <img src={imgPath} alt={rank} className={imgSize} />;
      }
      return <span className={`font-bold ${sizeClass}`}>{rank}</span>;
    }

    function Salpakan() {
      const [board, setBoard] = useState(initBoard());
      const [phase, setPhase] = useState('setup');
      const [mode, setMode] = useState(null);
      const [turn, setTurn] = useState(1);
      const [sel, setSel] = useState(null);
      const [moves, setMoves] = useState([]);
      const [msg, setMsg] = useState('Choose mode');
      const [devMode, setDevMode] = useState(false);
      const [setupPlayer, setSetupPlayer] = useState(1);
      const [inventory, setInventory] = useState({});
      const [showPicker, setShowPicker] = useState(null);
      const [showTurnLock, setShowTurnLock] = useState(false);
      const [pausePhase, setPausePhase] = useState(false);

      const startSetup = (m) => {
        setMode(m);
        setBoard(initBoard());
        const inv = {};
        RANKS.forEach(({ r, count }) => { inv[r] = count; });
        setInventory(inv);
        setSetupPlayer(1);
        setPhase('setup');
        setMsg('Player 1: Place your pieces');
      };

      const finishSetup = () => {
        const totalPieces = Object.values(inventory).reduce((sum, count) => sum + count, 0);
        if (totalPieces > 0) {
          setMsg('Place all 21 pieces first!');
          return;
        }
        if (setupPlayer === 1 && mode === '2player') {
          setShowTurnLock(true);
          setPausePhase(true);
        } else if (setupPlayer === 1 && mode === 'ai') {
          const nb = autoSetup(board, 2);
          setBoard(nb);
          setPhase('playing');
          setTurn(1);
          setMsg('Your turn');
        } else {
          setPhase('playing');
          setTurn(1);
          setShowTurnLock(true);
          setPausePhase(true);
        }
      };

      const confirmTurn = () => {
        if (pausePhase && setupPlayer === 1 && mode === '2player') {
          setSetupPlayer(2);
          const inv = {};
          RANKS.forEach(({ r, count }) => { inv[r] = count; });
          setInventory(inv);
          setMsg('Player 2: Place your pieces');
          setShowTurnLock(false);
          setPausePhase(false);
        } else if (pausePhase && phase === 'setup') {
          setPhase('playing');
          setTurn(1);
          setMsg('Player 1\'s turn');
          setShowTurnLock(false);
          setPausePhase(false);
        } else {
          setShowTurnLock(false);
        }
      };

      const placeOnBoard = (r, c, rank) => {
        if (board[r][c]) return;
        const nb = board.map(row => [...row]);
        nb[r][c] = { r: rank, p: setupPlayer, id: setupPlayer * 100 + Math.random() };
        setBoard(nb);
        setInventory({ ...inventory, [rank]: inventory[rank] - 1 });
        setShowPicker(null);
      };

      const removeFromBoard = (r, c) => {
        const piece = board[r][c];
        if (!piece || piece.p !== setupPlayer) return;
        const nb = board.map(row => [...row]);
        nb[r][c] = null;
        setBoard(nb);
        setInventory({ ...inventory, [piece.r]: inventory[piece.r] + 1 });
      };

      const handleSetupClick = (r, c) => {
        const rows = setupPlayer === 1 ? [7, 6, 5] : [0, 1, 2];
        if (!rows.includes(r)) return;
        
        if (board[r][c]) {
          removeFromBoard(r, c);
        } else {
          setShowPicker([r, c]);
        }
      };

      const handlePlayClick = (r, c) => {
        if (mode === 'ai' && turn !== 1) return;
        
        if (!sel) {
          if (board[r][c]?.p === turn) {
            setSel([r, c]);
            setMoves(validMoves(board, r, c));
          }
        } else {
          const [sr, sc] = sel;
          const validMove = moves.some(([mr, mc]) => mr === r && mc === c);
          
          if (validMove) {
            const nb = board.map(row => [...row]);
            const attacker = nb[sr][sc];
            const defender = nb[r][c];
            
            if (defender) {
              const res = battle(attacker, defender);
              if (res === 'win') {
                nb[r][c] = attacker;
                nb[sr][sc] = null;
                if (defender.r === 'FLAG') {
                  setMsg(`Player ${turn} wins! 🎉`);
                  setBoard(nb);
                  setMoves([]);
                  setSel(null);
                  return;
                }
              } else if (res === 'lose') {
                nb[sr][sc] = null;
              } else {
                nb[r][c] = null;
                nb[sr][sc] = null;
              }
            } else {
              nb[r][c] = attacker;
              nb[sr][sc] = null;
            }
            
            setBoard(nb);
            setSel(null);
            setMoves([]);
            
            if (mode === 'ai') {
              setTurn(2);
              setMsg('AI thinking...');
              setTimeout(() => {
                const aiM = aiMove(nb);
                if (!aiM) { setMsg('You win!'); return; }
                
                const nb2 = nb.map(row => [...row]);
                const [ar, ac] = aiM.from;
                const [tr, tc] = aiM.to;
                const aiA = nb2[ar][ac];
                const def = nb2[tr][tc];
                
                if (def) {
                  const res = battle(aiA, def);
                  if (res === 'win') {
                    nb2[tr][tc] = aiA;
                    nb2[ar][ac] = null;
                    if (def.r === 'FLAG') { setMsg('AI wins!'); setBoard(nb2); return; }
                  } else if (res === 'lose') {
                    nb2[ar][ac] = null;
                  } else {
                    nb2[tr][tc] = null;
                    nb2[ar][ac] = null;
                  }
                } else {
                  nb2[tr][tc] = aiA;
                  nb2[ar][ac] = null;
                }
                
                setBoard(nb2);
                setTurn(1);
                setMsg('Your turn');
              }, 800);
            } else {
              const nextTurn = turn === 1 ? 2 : 1;
              setTurn(nextTurn);
              setShowTurnLock(true);
            }
          } else {
            setSel(null);
            setMoves([]);
          }
        }
      };

      const renderBoard = () => {
        const perspective = phase === 'playing' && mode === '2player' ? turn : setupPlayer;
        const displayBoard = perspective === 2 ? [...board].reverse().map(row => [...row].reverse()) : board;
        
        return displayBoard.map((row, r) => {
          const actualR = perspective === 2 ? 7 - r : r;
          return (
            <div key={r} className="flex">
              {row.map((cell, c) => {
                const actualC = perspective === 2 ? 8 - c : c;
                const isSelected = sel?.[0] === actualR && sel?.[1] === actualC;
                const isValidMove = moves.some(([mr, mc]) => mr === actualR && mc === actualC);
                const canSee = devMode || !cell || cell.p === (phase === 'playing' ? turn : setupPlayer);
                
                return (
                  <div
                    key={c}
                    onClick={() => phase === 'setup' ? handleSetupClick(actualR, actualC) : handlePlayClick(actualR, actualC)}
                    className={`w-16 h-16 md:w-20 md:h-20 border-2 flex items-center justify-center font-bold cursor-pointer transition-all shadow-md ${
                      isSelected ? 'bg-yellow-400 scale-105 border-yellow-600 shadow-xl' : 
                      isValidMove ? 'bg-emerald-400 hover:bg-emerald-300 border-emerald-600' :
                      'bg-gradient-to-br from-amber-600 to-amber-700 hover:from-amber-500 hover:to-amber-600 border-amber-800'
                    } ${cell?.p === 1 ? 'text-blue-900' : cell?.p === 2 ? 'text-red-100' : ''}`}
                  >
                    {cell ? (canSee ? <PieceIcon rank={cell.r} player={cell.p} /> : <span className="text-3xl text-amber-200">?</span>) : ''}
                  </div>
                );
              })}
            </div>
          );
        });
      };

      return (
        <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 p-4">
          <div className="mb-6 text-center">
            <h1 className="text-5xl md:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-amber-400 via-yellow-500 to-amber-400 drop-shadow-lg mb-2">
              GAME OF THE GENERALS
            </h1>
            <div className="text-sm text-amber-300 italic">Salpakan</div>
          </div>
          
          {phase === 'setup' && mode === null && (
            <div className="flex gap-6 mb-8">
              <button onClick={() => startSetup('ai')} 
                className="px-10 py-5 bg-gradient-to-r from-blue-600 to-blue-700 text-white text-xl rounded-2xl font-bold hover:from-blue-500 hover:to-blue-600 shadow-2xl transform hover:scale-105 transition-all">
                🤖 vs AI
              </button>
              <button onClick={() => startSetup('2player')} 
                className="px-10 py-5 bg-gradient-to-r from-green-600 to-green-700 text-white text-xl rounded-2xl font-bold hover:from-green-500 hover:to-green-600 shadow-2xl transform hover:scale-105 transition-all">
                👥 2 Players
              </button>
            </div>
          )}
          
          <div className="text-2xl text-amber-300 mb-6 font-bold drop-shadow-lg">{msg}</div>
          
          <div className="inline-block bg-gradient-to-br from-amber-950 to-amber-900 p-4 rounded-2xl shadow-2xl border-4 border-amber-700">
            {renderBoard()}
          </div>
          
          {phase === 'setup' && (
            <div className="mt-6 px-8 py-4 bg-slate-800 rounded-xl shadow-xl border-2 border-slate-700">
              <div className="text-amber-300 text-lg font-bold">
                Pieces remaining: <span className="text-yellow-400 text-2xl">{Object.values(inventory).reduce((sum, count) => sum + count, 0)}</span> / 21
              </div>
            </div>
          )}
          
          <div className="flex gap-4 mt-6 flex-wrap justify-center">
            {phase === 'setup' && (
              <>
                <button onClick={finishSetup} 
                  className="px-8 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white text-lg rounded-xl font-bold hover:from-green-500 hover:to-green-600 shadow-lg transform hover:scale-105 transition-all">
                  {setupPlayer === 1 && mode === '2player' ? '✓ Next Player' : '🎮 Start Game'}
                </button>
                <button onClick={() => {
                  const nb = autoSetup(board, setupPlayer);
                  setBoard(nb);
                  const inv = {};
                  RANKS.forEach(({ r }) => { inv[r] = 0; });
                  setInventory(inv);
                }} className="px-8 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white text-lg rounded-xl font-bold hover:from-purple-500 hover:to-purple-600 shadow-lg transform hover:scale-105 transition-all">
                  ⚡ Auto Setup
                </button>
              </>
            )}
            <button onClick={() => setDevMode(!devMode)} 
              className="px-8 py-3 bg-gradient-to-r from-orange-600 to-orange-700 text-white text-lg rounded-xl font-bold hover:from-orange-500 hover:to-orange-600 shadow-lg transform hover:scale-105 transition-all">
              🔧 Dev: {devMode ? 'ON' : 'OFF'}
            </button>
            <button onClick={() => { setBoard(initBoard()); setPhase('setup'); setMode(null); setMsg('Choose mode'); setInventory({}); setSel(null); setMoves([]); setShowPicker(null); setShowTurnLock(false); }} 
              className="px-8 py-3 bg-gradient-to-r from-slate-600 to-slate-700 text-white text-lg rounded-xl font-bold hover:from-slate-500 hover:to-slate-600 shadow-lg transform hover:scale-105 transition-all">
              🔄 Reset
            </button>
          </div>

          {showPicker && (
            <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]"
                 onClick={() => setShowPicker(null)}>
              <div className="bg-gradient-to-br from-slate-800 to-slate-900 p-8 rounded-3xl shadow-2xl max-w-3xl border-4 border-amber-600 animate-[zoomIn_0.3s_ease-out]"
                   onClick={(e) => e.stopPropagation()}>
                <h2 className="text-3xl font-black text-amber-400 mb-6 text-center">Choose Your Piece</h2>
                <div className="grid grid-cols-5 gap-4">
                  {RANKS.map(({ r, count }) => (
                    inventory[r] > 0 && (
                      <button
                        key={r}
                        onClick={() => placeOnBoard(showPicker[0], showPicker[1], r)}
                        className={`px-4 py-4 rounded-xl font-bold text-lg transition-all hover:scale-110 shadow-lg ${
                          setupPlayer === 1 ? 'bg-gradient-to-br from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white' : 'bg-gradient-to-br from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white'
                        }`}
                      >
                        <PieceIcon rank={r} player={setupPlayer} size="sm" />
                        <div className="text-sm mt-2 bg-black bg-opacity-30 rounded px-2 py-1">×{inventory[r]}</div>
                      </button>
                    )
                  ))}
                </div>
                <button onClick={() => setShowPicker(null)} 
                        className="mt-6 w-full px-6 py-3 bg-gray-700 text-white text-lg rounded-xl hover:bg-gray-600 font-bold shadow-lg">
                  Cancel
                </button>
              </div>
            </div>
          )}

          {showTurnLock && (
            <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 backdrop-blur-md animate-[fadeIn_0.3s_ease-out]">
              <div className="bg-gradient-to-br from-slate-800 to-slate-900 p-12 rounded-3xl shadow-2xl max-w-lg border-4 border-amber-600 text-center animate-[zoomIn_0.4s_ease-out]">
                <div className="text-6xl mb-6">🔒</div>
                <h2 className="text-4xl font-black text-amber-400 mb-4">
                  {pausePhase ? (setupPlayer === 1 && mode === '2player' ? 'Player 2\'s Turn' : 'Game Starting!') : `Player ${turn}'s Turn`}
                </h2>
                <p className="text-xl text-gray-300 mb-8">
                  {pausePhase ? 'Pass the device to the next player' : 'Are you ready?'}
                </p>
                <button onClick={confirmTurn}
                        className="px-12 py-5 bg-gradient-to-r from-green-600 to-green-700 text-white text-2xl rounded-2xl font-bold hover:from-green-500 hover:to-green-600 shadow-2xl transform hover:scale-105 transition-all">
                  I'm Ready ✓
                </button>
                <p className="text-sm text-amber-300 mt-6 italic">
                  ⚠️ This lock prevents cheating - confirm only when you're the current player
                </p>
              </div>
            </div>
          )}

          <style>{`
            @keyframes fadeIn {
              from { opacity: 0; }
              to { opacity: 1; }
            }
            @keyframes zoomIn {
              from { transform: scale(0.8); opacity: 0; }
              to { transform: scale(1); opacity: 1; }
            }
          `}</style>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<Salpakan />);
  </script>
</body>
</html>